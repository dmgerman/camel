begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.camel.component.salesforce.internal.processor
package|package
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|internal
operator|.
name|processor
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|InvocationTargetException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Method
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URLEncoder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Optional
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|StreamSupport
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|AsyncCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Exchange
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|TypeConverter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|NotFoundBehaviour
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceComponent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpoint
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|api
operator|.
name|NoSuchSObjectException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|api
operator|.
name|SalesforceException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|api
operator|.
name|dto
operator|.
name|AbstractSObjectBase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|api
operator|.
name|dto
operator|.
name|approval
operator|.
name|ApprovalRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|api
operator|.
name|dto
operator|.
name|approval
operator|.
name|ApprovalRequests
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|internal
operator|.
name|client
operator|.
name|RestClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|internal
operator|.
name|client
operator|.
name|RestClient
operator|.
name|ResponseCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|util
operator|.
name|ServiceHelper
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|APEX_METHOD
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|APEX_QUERY_PARAM_PREFIX
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|APEX_URL
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_BLOB_FIELD_NAME
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_CLASS
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_EXT_ID_NAME
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_EXT_ID_VALUE
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_FIELDS
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_ID
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_NAME
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_QUERY
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|salesforce
operator|.
name|SalesforceEndpointConfig
operator|.
name|SOBJECT_SEARCH
import|;
end_import

begin_class
DECL|class|AbstractRestProcessor
specifier|public
specifier|abstract
class|class
name|AbstractRestProcessor
extends|extends
name|AbstractSalesforceProcessor
block|{
DECL|field|RESPONSE_CLASS
specifier|protected
specifier|static
specifier|final
name|String
name|RESPONSE_CLASS
init|=
name|AbstractRestProcessor
operator|.
name|class
operator|.
name|getName
argument_list|()
operator|+
literal|".responseClass"
decl_stmt|;
DECL|field|URL_TEMPLATE
specifier|private
specifier|static
specifier|final
name|Pattern
name|URL_TEMPLATE
init|=
name|Pattern
operator|.
name|compile
argument_list|(
literal|"\\{([^\\{\\}]+)\\}"
argument_list|)
decl_stmt|;
DECL|field|restClient
specifier|private
name|RestClient
name|restClient
decl_stmt|;
DECL|field|classMap
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Class
argument_list|<
name|?
argument_list|>
argument_list|>
name|classMap
decl_stmt|;
DECL|field|notFoundBehaviour
specifier|private
specifier|final
name|NotFoundBehaviour
name|notFoundBehaviour
decl_stmt|;
DECL|method|AbstractRestProcessor (SalesforceEndpoint endpoint)
specifier|public
name|AbstractRestProcessor
parameter_list|(
name|SalesforceEndpoint
name|endpoint
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|super
argument_list|(
name|endpoint
argument_list|)
expr_stmt|;
specifier|final
name|SalesforceEndpointConfig
name|configuration
init|=
name|endpoint
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|notFoundBehaviour
operator|=
name|configuration
operator|.
name|getNotFoundBehaviour
argument_list|()
expr_stmt|;
specifier|final
name|SalesforceComponent
name|salesforceComponent
init|=
name|endpoint
operator|.
name|getComponent
argument_list|()
decl_stmt|;
name|this
operator|.
name|restClient
operator|=
name|salesforceComponent
operator|.
name|createRestClientFor
argument_list|(
name|endpoint
argument_list|)
expr_stmt|;
name|this
operator|.
name|classMap
operator|=
name|endpoint
operator|.
name|getComponent
argument_list|()
operator|.
name|getClassMap
argument_list|()
expr_stmt|;
block|}
comment|// used in unit tests
DECL|method|AbstractRestProcessor (final SalesforceEndpoint endpoint, final RestClient restClient, final Map<String, Class<?>> classMap)
name|AbstractRestProcessor
parameter_list|(
specifier|final
name|SalesforceEndpoint
name|endpoint
parameter_list|,
specifier|final
name|RestClient
name|restClient
parameter_list|,
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Class
argument_list|<
name|?
argument_list|>
argument_list|>
name|classMap
parameter_list|)
block|{
name|super
argument_list|(
name|endpoint
argument_list|)
expr_stmt|;
name|this
operator|.
name|restClient
operator|=
name|restClient
expr_stmt|;
name|this
operator|.
name|classMap
operator|=
name|classMap
expr_stmt|;
specifier|final
name|SalesforceEndpointConfig
name|configuration
init|=
name|endpoint
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|notFoundBehaviour
operator|=
name|configuration
operator|.
name|getNotFoundBehaviour
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|start ()
specifier|public
name|void
name|start
parameter_list|()
throws|throws
name|Exception
block|{
name|ServiceHelper
operator|.
name|startService
argument_list|(
name|restClient
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|stop ()
specifier|public
name|void
name|stop
parameter_list|()
throws|throws
name|Exception
block|{
name|ServiceHelper
operator|.
name|stopService
argument_list|(
name|restClient
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|process (final Exchange exchange, final AsyncCallback callback)
specifier|public
specifier|final
name|boolean
name|process
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
comment|// pre-process request message
try|try
block|{
name|processRequest
argument_list|(
name|exchange
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SalesforceException
name|e
parameter_list|)
block|{
name|exchange
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|callback
operator|.
name|done
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
name|exchange
operator|.
name|setException
argument_list|(
operator|new
name|SalesforceException
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|callback
operator|.
name|done
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
comment|// call Salesforce asynchronously
try|try
block|{
comment|// call Operation using REST client
switch|switch
condition|(
name|operationName
condition|)
block|{
case|case
name|GET_VERSIONS
case|:
name|processGetVersions
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_RESOURCES
case|:
name|processGetResources
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_GLOBAL_OBJECTS
case|:
name|processGetGlobalObjects
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_BASIC_INFO
case|:
name|processGetBasicInfo
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_DESCRIPTION
case|:
name|processGetDescription
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_SOBJECT
case|:
name|processGetSobject
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|CREATE_SOBJECT
case|:
name|processCreateSobject
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|UPDATE_SOBJECT
case|:
name|processUpdateSobject
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|DELETE_SOBJECT
case|:
name|processDeleteSobject
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_SOBJECT_WITH_ID
case|:
name|processGetSobjectWithId
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|UPSERT_SOBJECT
case|:
name|processUpsertSobject
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|DELETE_SOBJECT_WITH_ID
case|:
name|processDeleteSobjectWithId
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_BLOB_FIELD
case|:
name|processGetBlobField
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|QUERY
case|:
name|processQuery
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|QUERY_MORE
case|:
name|processQueryMore
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|QUERY_ALL
case|:
name|processQueryAll
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|SEARCH
case|:
name|processSearch
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|APEX_CALL
case|:
name|processApexCall
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECENT
case|:
name|processRecent
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|LIMITS
case|:
name|processLimits
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|APPROVAL
case|:
name|processApproval
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
case|case
name|APPROVALS
case|:
name|processApprovals
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|SalesforceException
argument_list|(
literal|"Unknown operation name: "
operator|+
name|operationName
operator|.
name|value
argument_list|()
argument_list|,
literal|null
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|SalesforceException
name|e
parameter_list|)
block|{
name|exchange
operator|.
name|setException
argument_list|(
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Error processing %s: [%s] \"%s\""
argument_list|,
name|operationName
operator|.
name|value
argument_list|()
argument_list|,
name|e
operator|.
name|getStatusCode
argument_list|()
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|callback
operator|.
name|done
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|RuntimeException
name|e
parameter_list|)
block|{
name|exchange
operator|.
name|setException
argument_list|(
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Unexpected Error processing %s: \"%s\""
argument_list|,
name|operationName
operator|.
name|value
argument_list|()
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
argument_list|,
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|callback
operator|.
name|done
argument_list|(
literal|true
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
comment|// continue routing asynchronously
return|return
literal|false
return|;
block|}
DECL|method|processApproval (final Exchange exchange, final AsyncCallback callback)
specifier|final
name|void
name|processApproval
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|TypeConverter
name|converter
init|=
name|exchange
operator|.
name|getContext
argument_list|()
operator|.
name|getTypeConverter
argument_list|()
decl_stmt|;
specifier|final
name|ApprovalRequest
name|approvalRequestFromHeader
init|=
name|getParameter
argument_list|(
name|SalesforceEndpointConfig
operator|.
name|APPROVAL
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|IS_OPTIONAL
argument_list|,
name|ApprovalRequest
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|final
name|boolean
name|requestGivenInHeader
init|=
name|approvalRequestFromHeader
operator|!=
literal|null
decl_stmt|;
comment|// find if there is a ApprovalRequest as `approval` in the message header
specifier|final
name|ApprovalRequest
name|approvalHeader
init|=
name|Optional
operator|.
name|ofNullable
argument_list|(
name|approvalRequestFromHeader
argument_list|)
operator|.
name|orElse
argument_list|(
operator|new
name|ApprovalRequest
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|Message
name|incomingMessage
init|=
name|exchange
operator|.
name|getIn
argument_list|()
decl_stmt|;
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|incomingHeaders
init|=
name|incomingMessage
operator|.
name|getHeaders
argument_list|()
decl_stmt|;
specifier|final
name|boolean
name|requestGivenInParametersInHeader
init|=
name|processApprovalHeaderValues
argument_list|(
name|approvalHeader
argument_list|,
name|incomingHeaders
argument_list|)
decl_stmt|;
specifier|final
name|boolean
name|nothingInheader
init|=
operator|!
name|requestGivenInHeader
operator|&&
operator|!
name|requestGivenInParametersInHeader
decl_stmt|;
specifier|final
name|Object
name|approvalBody
init|=
name|incomingMessage
operator|.
name|getBody
argument_list|()
decl_stmt|;
specifier|final
name|boolean
name|bodyIsIterable
init|=
name|approvalBody
operator|instanceof
name|Iterable
decl_stmt|;
specifier|final
name|boolean
name|bodyIsIterableButEmpty
init|=
name|bodyIsIterable
operator|&&
operator|!
operator|(
operator|(
name|Iterable
operator|)
name|approvalBody
operator|)
operator|.
name|iterator
argument_list|()
operator|.
name|hasNext
argument_list|()
decl_stmt|;
comment|// body contains nothing of interest if it's null, holds an empty iterable or cannot be converted to
comment|// ApprovalRequest
specifier|final
name|boolean
name|nothingInBody
init|=
operator|!
operator|(
name|approvalBody
operator|!=
literal|null
operator|&&
operator|!
name|bodyIsIterableButEmpty
operator|)
decl_stmt|;
comment|// we found nothing in the headers or the body
if|if
condition|(
name|nothingInheader
operator|&&
name|nothingInBody
condition|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
literal|"Missing "
operator|+
name|SalesforceEndpointConfig
operator|.
name|APPROVAL
operator|+
literal|" parameter in header or ApprovalRequest or List of ApprovalRequests body"
argument_list|,
literal|0
argument_list|)
throw|;
block|}
comment|// let's try to resolve the request body to send
specifier|final
name|ApprovalRequests
name|requestsBody
decl_stmt|;
if|if
condition|(
name|nothingInBody
condition|)
block|{
comment|// nothing in body use the header values only
name|requestsBody
operator|=
operator|new
name|ApprovalRequests
argument_list|(
name|approvalHeader
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bodyIsIterable
condition|)
block|{
comment|// multiple ApprovalRequests are found
specifier|final
name|Iterable
argument_list|<
name|?
argument_list|>
name|approvalRequests
init|=
operator|(
name|Iterable
argument_list|<
name|?
argument_list|>
operator|)
name|approvalBody
decl_stmt|;
comment|// use header values as template and apply them to the body
specifier|final
name|List
argument_list|<
name|ApprovalRequest
argument_list|>
name|requests
init|=
name|StreamSupport
operator|.
name|stream
argument_list|(
name|approvalRequests
operator|.
name|spliterator
argument_list|()
argument_list|,
literal|false
argument_list|)
operator|.
name|map
argument_list|(
name|value
lambda|->
name|converter
operator|.
name|convertTo
argument_list|(
name|ApprovalRequest
operator|.
name|class
argument_list|,
name|value
argument_list|)
argument_list|)
operator|.
name|map
argument_list|(
name|request
lambda|->
name|request
operator|.
name|applyTemplate
argument_list|(
name|approvalHeader
argument_list|)
argument_list|)
operator|.
name|collect
argument_list|(
name|Collectors
operator|.
name|toList
argument_list|()
argument_list|)
decl_stmt|;
name|requestsBody
operator|=
operator|new
name|ApprovalRequests
argument_list|(
name|requests
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// we've looked at the body, and are expecting to see something resembling ApprovalRequest in there
comment|// but lets see if that is so
specifier|final
name|ApprovalRequest
name|given
init|=
name|converter
operator|.
name|tryConvertTo
argument_list|(
name|ApprovalRequest
operator|.
name|class
argument_list|,
name|approvalBody
argument_list|)
decl_stmt|;
specifier|final
name|ApprovalRequest
name|request
init|=
name|Optional
operator|.
name|ofNullable
argument_list|(
name|given
argument_list|)
operator|.
name|orElse
argument_list|(
operator|new
name|ApprovalRequest
argument_list|()
argument_list|)
operator|.
name|applyTemplate
argument_list|(
name|approvalHeader
argument_list|)
decl_stmt|;
name|requestsBody
operator|=
operator|new
name|ApprovalRequests
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
specifier|final
name|InputStream
name|request
init|=
name|getRequestStream
argument_list|(
name|incomingMessage
argument_list|,
name|requestsBody
argument_list|)
decl_stmt|;
name|restClient
operator|.
name|approval
argument_list|(
name|request
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
DECL|method|processApprovalHeaderValues (final ApprovalRequest approvalRequest, final Map<String, Object> incomingHeaderValues)
specifier|final
name|boolean
name|processApprovalHeaderValues
parameter_list|(
specifier|final
name|ApprovalRequest
name|approvalRequest
parameter_list|,
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|incomingHeaderValues
parameter_list|)
block|{
comment|// loop trough all header values, find those that start with `approval.`
comment|// set the property value to the given approvalRequest and return if
comment|// any value was set
return|return
name|incomingHeaderValues
operator|.
name|entrySet
argument_list|()
operator|.
name|stream
argument_list|()
operator|.
name|filter
argument_list|(
name|kv
lambda|->
name|kv
operator|.
name|getKey
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"approval."
argument_list|)
argument_list|)
operator|.
name|map
argument_list|(
name|kv
lambda|->
block|{
name|final
name|String
name|property
operator|=
name|kv
operator|.
name|getKey
argument_list|()
operator|.
name|substring
argument_list|(
literal|9
argument_list|)
argument_list|;
name|Object
name|value
operator|=
name|kv
operator|.
name|getValue
argument_list|()
argument_list|;              if
operator|(
name|value
operator|!=
literal|null
operator|)
block|{
try|try
block|{
name|setPropertyValue
argument_list|(
name|approvalRequest
argument_list|,
name|property
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
catch|catch
parameter_list|(
name|SalesforceException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
return|return
literal|false
return|;
block|}
end_class

begin_expr_stmt
unit|)
operator|.
name|reduce
argument_list|(
literal|false
argument_list|,
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
lambda|->
name|a
operator|||
name|b
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
unit|}      private
DECL|method|processApprovals (final Exchange exchange, final AsyncCallback callback)
name|void
name|processApprovals
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
name|restClient
operator|.
name|approvals
argument_list|(
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetVersions (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetVersions
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
name|restClient
operator|.
name|getVersions
argument_list|(
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetResources (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetResources
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
name|restClient
operator|.
name|getResources
argument_list|(
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetGlobalObjects (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetGlobalObjects
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
name|restClient
operator|.
name|getGlobalObjects
argument_list|(
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetBasicInfo (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetBasicInfo
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
init|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
name|restClient
operator|.
name|getBasicInfo
argument_list|(
name|sObjectName
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetDescription (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetDescription
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|restClient
operator|.
name|getDescription
argument_list|(
name|sObjectName
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetSobject (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetSobject
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
name|String
name|sObjectIdValue
decl_stmt|;
comment|// determine parameters from input AbstractSObject
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|sObjectIdValue
operator|=
name|sObjectBase
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_ID
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|sObjectId
init|=
name|sObjectIdValue
decl_stmt|;
comment|// use sObject name to load class
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
name|sObjectName
argument_list|)
expr_stmt|;
comment|// get optional field list
name|String
name|fieldsValue
init|=
name|getParameter
argument_list|(
name|SOBJECT_FIELDS
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|IS_OPTIONAL
argument_list|)
decl_stmt|;
name|String
index|[]
name|fields
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|fieldsValue
operator|!=
literal|null
condition|)
block|{
name|fields
operator|=
name|fieldsValue
operator|.
name|split
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|restClient
operator|.
name|getSObject
argument_list|(
name|sObjectName
argument_list|,
name|sObjectId
argument_list|,
name|fields
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processCreateSobject (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processCreateSobject
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
comment|// determine parameters from input AbstractSObject
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
name|restClient
operator|.
name|createSObject
argument_list|(
name|sObjectName
argument_list|,
name|getRequestStream
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processUpdateSobject (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processUpdateSobject
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
comment|// determine parameters from input AbstractSObject
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
name|String
name|sObjectId
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
comment|// remember the sObject Id
name|sObjectId
operator|=
name|sObjectBase
operator|.
name|getId
argument_list|()
expr_stmt|;
comment|// clear base object fields, which cannot be updated
name|sObjectBase
operator|.
name|clearBaseFields
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectId
operator|=
name|getParameter
argument_list|(
name|SOBJECT_ID
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|finalsObjectId
init|=
name|sObjectId
decl_stmt|;
name|restClient
operator|.
name|updateSObject
argument_list|(
name|sObjectName
argument_list|,
name|sObjectId
argument_list|,
name|getRequestStream
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
name|finalsObjectId
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processDeleteSobject (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processDeleteSobject
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
comment|// determine parameters from input AbstractSObject
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
name|String
name|sObjectIdValue
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|sObjectIdValue
operator|=
name|sObjectBase
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_ID
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|sObjectId
init|=
name|sObjectIdValue
decl_stmt|;
name|restClient
operator|.
name|deleteSObject
argument_list|(
name|sObjectName
argument_list|,
name|sObjectId
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
name|sObjectId
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetSobjectWithId (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetSobjectWithId
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
name|Object
name|oldValue
init|=
literal|null
decl_stmt|;
name|String
name|sObjectExtIdValue
decl_stmt|;
specifier|final
name|String
name|sObjectExtIdName
init|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// determine parameters from input AbstractSObject
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|oldValue
operator|=
name|getAndClearPropertyValue
argument_list|(
name|sObjectBase
argument_list|,
name|sObjectExtIdName
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|oldValue
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_VALUE
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
comment|// use sObject name to load class
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
name|sObjectName
argument_list|)
expr_stmt|;
specifier|final
name|Object
name|finalOldValue
init|=
name|oldValue
decl_stmt|;
name|restClient
operator|.
name|getSObjectWithId
argument_list|(
name|sObjectName
argument_list|,
name|sObjectExtIdName
argument_list|,
name|sObjectExtIdValue
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
literal|null
argument_list|,
name|sObjectExtIdName
argument_list|,
name|finalOldValue
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processUpsertSobject (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processUpsertSobject
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
name|String
name|sObjectExtIdValue
decl_stmt|;
specifier|final
name|String
name|sObjectExtIdName
init|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// determine parameters from input AbstractSObject
name|Object
name|oldValue
init|=
literal|null
decl_stmt|;
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|oldValue
operator|=
name|getAndClearPropertyValue
argument_list|(
name|sObjectBase
argument_list|,
name|sObjectExtIdName
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|oldValue
operator|.
name|toString
argument_list|()
expr_stmt|;
comment|// clear base object fields, which cannot be updated
name|sObjectBase
operator|.
name|clearBaseFields
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_VALUE
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|Object
name|finalOldValue
init|=
name|oldValue
decl_stmt|;
name|restClient
operator|.
name|upsertSObject
argument_list|(
name|sObjectName
argument_list|,
name|sObjectExtIdName
argument_list|,
name|sObjectExtIdValue
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|getRequestStream
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
literal|null
argument_list|,
name|sObjectExtIdName
argument_list|,
name|finalOldValue
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processDeleteSobjectWithId (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processDeleteSobjectWithId
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
specifier|final
name|String
name|sObjectExtIdName
init|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// determine parameters from input AbstractSObject
name|Object
name|oldValue
init|=
literal|null
decl_stmt|;
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
name|String
name|sObjectExtIdValue
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|oldValue
operator|=
name|getAndClearPropertyValue
argument_list|(
name|sObjectBase
argument_list|,
name|sObjectExtIdName
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|oldValue
operator|.
name|toString
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectExtIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_EXT_ID_VALUE
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|Object
name|finalOldValue
init|=
name|oldValue
decl_stmt|;
name|restClient
operator|.
name|deleteSObjectWithId
argument_list|(
name|sObjectName
argument_list|,
name|sObjectExtIdName
argument_list|,
name|sObjectExtIdValue
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
literal|null
argument_list|,
name|sObjectExtIdName
argument_list|,
name|finalOldValue
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processGetBlobField (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processGetBlobField
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
name|String
name|sObjectName
decl_stmt|;
comment|// get blob field name
specifier|final
name|String
name|sObjectBlobFieldName
init|=
name|getParameter
argument_list|(
name|SOBJECT_BLOB_FIELD_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// determine parameters from input AbstractSObject
specifier|final
name|AbstractSObjectBase
name|sObjectBase
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|(
name|AbstractSObjectBase
operator|.
name|class
argument_list|)
decl_stmt|;
name|String
name|sObjectIdValue
decl_stmt|;
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
name|sObjectName
operator|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
expr_stmt|;
name|sObjectIdValue
operator|=
name|sObjectBase
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sObjectName
operator|=
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
name|sObjectIdValue
operator|=
name|getParameter
argument_list|(
name|SOBJECT_ID
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
expr_stmt|;
block|}
specifier|final
name|String
name|sObjectId
init|=
name|sObjectIdValue
decl_stmt|;
name|restClient
operator|.
name|getBlobField
argument_list|(
name|sObjectName
argument_list|,
name|sObjectId
argument_list|,
name|sObjectBlobFieldName
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
operator|new
name|RestClient
operator|.
name|ResponseCallback
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|onResponse
parameter_list|(
name|InputStream
name|response
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|exception
parameter_list|)
block|{
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
expr_stmt|;
name|restoreFields
argument_list|(
name|exchange
argument_list|,
name|sObjectBase
argument_list|,
name|sObjectId
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processQuery (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processQuery
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|String
name|sObjectQuery
init|=
name|getParameter
argument_list|(
name|SOBJECT_QUERY
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// use custom response class property
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|restClient
operator|.
name|query
argument_list|(
name|sObjectQuery
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processQueryMore (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processQueryMore
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
comment|// reuse SOBJECT_QUERY parameter name for nextRecordsUrl
specifier|final
name|String
name|nextRecordsUrl
init|=
name|getParameter
argument_list|(
name|SOBJECT_QUERY
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// use custom response class property
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|restClient
operator|.
name|queryMore
argument_list|(
name|nextRecordsUrl
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processQueryAll (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processQueryAll
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|String
name|sObjectQuery
init|=
name|getParameter
argument_list|(
name|SOBJECT_QUERY
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
comment|// use custom response class property
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|restClient
operator|.
name|queryAll
argument_list|(
name|sObjectQuery
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processSearch (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processSearch
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|String
name|sObjectSearch
init|=
name|getParameter
argument_list|(
name|SOBJECT_SEARCH
argument_list|,
name|exchange
argument_list|,
name|USE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
name|restClient
operator|.
name|search
argument_list|(
name|sObjectSearch
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processApexCall (final Exchange exchange, final AsyncCallback callback)
specifier|private
name|void
name|processApexCall
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
comment|// HTTP method, URL and query params for APEX call
specifier|final
name|String
name|apexUrl
init|=
name|getApexUrl
argument_list|(
name|exchange
argument_list|)
decl_stmt|;
name|String
name|apexMethod
init|=
name|getParameter
argument_list|(
name|APEX_METHOD
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|IS_OPTIONAL
argument_list|)
decl_stmt|;
comment|// default to GET
if|if
condition|(
name|apexMethod
operator|==
literal|null
condition|)
block|{
name|apexMethod
operator|=
literal|"GET"
expr_stmt|;
name|log
operator|.
name|debug
argument_list|(
literal|"Using HTTP GET method by default for APEX REST call for {}"
argument_list|,
name|apexUrl
argument_list|)
expr_stmt|;
block|}
specifier|final
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|queryParams
init|=
name|getQueryParams
argument_list|(
name|exchange
argument_list|)
decl_stmt|;
comment|// set response class
name|setResponseClass
argument_list|(
name|exchange
argument_list|,
name|getParameter
argument_list|(
name|SOBJECT_NAME
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|IS_OPTIONAL
argument_list|)
argument_list|)
expr_stmt|;
comment|// set request stream
specifier|final
name|Object
name|requestBody
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|()
decl_stmt|;
specifier|final
name|InputStream
name|requestDto
init|=
operator|(
name|requestBody
operator|!=
literal|null
operator|&&
operator|!
operator|(
name|requestBody
operator|instanceof
name|Map
operator|)
operator|)
condition|?
name|getRequestStream
argument_list|(
name|exchange
argument_list|)
else|:
literal|null
decl_stmt|;
name|restClient
operator|.
name|apexCall
argument_list|(
name|apexMethod
argument_list|,
name|apexUrl
argument_list|,
name|queryParams
argument_list|,
name|requestDto
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|getApexUrl (Exchange exchange)
specifier|private
name|String
name|getApexUrl
parameter_list|(
name|Exchange
name|exchange
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|String
name|apexUrl
init|=
name|getParameter
argument_list|(
name|APEX_URL
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
specifier|final
name|Matcher
name|matcher
init|=
name|URL_TEMPLATE
operator|.
name|matcher
argument_list|(
name|apexUrl
argument_list|)
decl_stmt|;
name|StringBuilder
name|result
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|int
name|start
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|matcher
operator|.
name|find
argument_list|()
condition|)
block|{
comment|// append part before parameter template
name|result
operator|.
name|append
argument_list|(
name|apexUrl
operator|.
name|substring
argument_list|(
name|start
argument_list|,
name|matcher
operator|.
name|start
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|start
operator|=
name|matcher
operator|.
name|end
argument_list|()
expr_stmt|;
comment|// append template value from exchange header
specifier|final
name|String
name|parameterName
init|=
name|matcher
operator|.
name|group
argument_list|(
literal|1
argument_list|)
decl_stmt|;
specifier|final
name|Object
name|value
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getHeader
argument_list|(
name|parameterName
argument_list|)
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Missing APEX URL template header "
operator|+
name|parameterName
argument_list|)
throw|;
block|}
try|try
block|{
name|result
operator|.
name|append
argument_list|(
name|URLEncoder
operator|.
name|encode
argument_list|(
name|String
operator|.
name|valueOf
argument_list|(
name|value
argument_list|)
argument_list|,
literal|"UTF-8"
argument_list|)
operator|.
name|replaceAll
argument_list|(
literal|"\\+"
argument_list|,
literal|"%20"
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsupportedEncodingException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
literal|"Unexpected error: "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
if|if
condition|(
name|start
operator|!=
literal|0
condition|)
block|{
comment|// append remaining URL
name|result
operator|.
name|append
argument_list|(
name|apexUrl
operator|.
name|substring
argument_list|(
name|start
argument_list|)
argument_list|)
expr_stmt|;
specifier|final
name|String
name|resolvedUrl
init|=
name|result
operator|.
name|toString
argument_list|()
decl_stmt|;
name|log
operator|.
name|debug
argument_list|(
literal|"Resolved APEX URL {} to {}"
argument_list|,
name|apexUrl
argument_list|,
name|resolvedUrl
argument_list|)
expr_stmt|;
return|return
name|resolvedUrl
return|;
block|}
return|return
name|apexUrl
return|;
block|}
end_function

begin_function
DECL|method|processRecent (Exchange exchange, AsyncCallback callback)
specifier|private
name|void
name|processRecent
parameter_list|(
name|Exchange
name|exchange
parameter_list|,
name|AsyncCallback
name|callback
parameter_list|)
throws|throws
name|SalesforceException
block|{
specifier|final
name|Integer
name|limit
init|=
name|getParameter
argument_list|(
name|SalesforceEndpointConfig
operator|.
name|LIMIT
argument_list|,
name|exchange
argument_list|,
literal|true
argument_list|,
literal|true
argument_list|,
name|Integer
operator|.
name|class
argument_list|)
decl_stmt|;
name|restClient
operator|.
name|recent
argument_list|(
name|limit
argument_list|,
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processLimits (Exchange exchange, AsyncCallback callback)
specifier|private
name|void
name|processLimits
parameter_list|(
name|Exchange
name|exchange
parameter_list|,
name|AsyncCallback
name|callback
parameter_list|)
block|{
name|restClient
operator|.
name|limits
argument_list|(
name|determineHeaders
argument_list|(
name|exchange
argument_list|)
argument_list|,
name|processWithResponseCallback
argument_list|(
name|exchange
argument_list|,
name|callback
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
annotation|@
name|SuppressWarnings
argument_list|(
literal|"unchecked"
argument_list|)
DECL|method|getQueryParams (Exchange exchange)
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|getQueryParams
parameter_list|(
name|Exchange
name|exchange
parameter_list|)
block|{
comment|// use endpoint map
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|queryParams
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|(
name|endpoint
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getApexQueryParams
argument_list|()
argument_list|)
decl_stmt|;
comment|// look for individual properties, allowing endpoint properties to be overridden
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|entry
range|:
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getHeaders
argument_list|()
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|startsWith
argument_list|(
name|APEX_QUERY_PARAM_PREFIX
argument_list|)
condition|)
block|{
name|queryParams
operator|.
name|put
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|substring
argument_list|(
name|APEX_QUERY_PARAM_PREFIX
operator|.
name|length
argument_list|()
argument_list|)
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// add params from body if it's a map
specifier|final
name|Object
name|body
init|=
name|exchange
operator|.
name|getIn
argument_list|()
operator|.
name|getBody
argument_list|()
decl_stmt|;
if|if
condition|(
name|body
operator|instanceof
name|Map
condition|)
block|{
name|queryParams
operator|.
name|putAll
argument_list|(
operator|(
name|Map
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
operator|)
name|body
argument_list|)
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Using APEX query params {}"
argument_list|,
name|queryParams
argument_list|)
expr_stmt|;
return|return
name|queryParams
return|;
block|}
end_function

begin_function
DECL|method|restoreFields (Exchange exchange, AbstractSObjectBase sObjectBase, String sObjectId, String sObjectExtIdName, Object oldValue)
specifier|private
name|void
name|restoreFields
parameter_list|(
name|Exchange
name|exchange
parameter_list|,
name|AbstractSObjectBase
name|sObjectBase
parameter_list|,
name|String
name|sObjectId
parameter_list|,
name|String
name|sObjectExtIdName
parameter_list|,
name|Object
name|oldValue
parameter_list|)
block|{
comment|// restore fields
if|if
condition|(
name|sObjectBase
operator|!=
literal|null
condition|)
block|{
comment|// restore the Id if it was cleared
if|if
condition|(
name|sObjectId
operator|!=
literal|null
condition|)
block|{
name|sObjectBase
operator|.
name|setId
argument_list|(
name|sObjectId
argument_list|)
expr_stmt|;
block|}
comment|// restore the external id if it was cleared
if|if
condition|(
name|sObjectExtIdName
operator|!=
literal|null
operator|&&
name|oldValue
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|setPropertyValue
argument_list|(
name|sObjectBase
argument_list|,
name|sObjectExtIdName
argument_list|,
name|oldValue
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SalesforceException
name|e
parameter_list|)
block|{
comment|// YES, the exchange may fail if the property cannot be reset!!!
name|exchange
operator|.
name|setException
argument_list|(
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
DECL|method|setPropertyValue (Object sObjectBase, String name, Object value)
specifier|private
name|void
name|setPropertyValue
parameter_list|(
name|Object
name|sObjectBase
parameter_list|,
name|String
name|name
parameter_list|,
name|Object
name|value
parameter_list|)
throws|throws
name|SalesforceException
block|{
try|try
block|{
comment|// set the value with the set method
name|Method
name|setMethod
init|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
literal|"set"
operator|+
name|name
argument_list|,
name|value
operator|.
name|getClass
argument_list|()
argument_list|)
decl_stmt|;
name|setMethod
operator|.
name|invoke
argument_list|(
name|sObjectBase
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NoSuchMethodException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"SObject %s does not have a field %s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|,
name|name
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InvocationTargetException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Error setting value %s.%s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
name|name
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|IllegalAccessException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Error accessing value %s.%s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
name|name
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_function
DECL|method|getAndClearPropertyValue (AbstractSObjectBase sObjectBase, String propertyName)
specifier|private
name|Object
name|getAndClearPropertyValue
parameter_list|(
name|AbstractSObjectBase
name|sObjectBase
parameter_list|,
name|String
name|propertyName
parameter_list|)
throws|throws
name|SalesforceException
block|{
try|try
block|{
comment|// obtain the value using the get method
name|Method
name|getMethod
init|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
literal|"get"
operator|+
name|propertyName
argument_list|)
decl_stmt|;
name|Object
name|value
init|=
name|getMethod
operator|.
name|invoke
argument_list|(
name|sObjectBase
argument_list|)
decl_stmt|;
comment|// clear the value with the set method
name|Method
name|setMethod
init|=
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getMethod
argument_list|(
literal|"set"
operator|+
name|propertyName
argument_list|,
name|getMethod
operator|.
name|getReturnType
argument_list|()
argument_list|)
decl_stmt|;
name|setMethod
operator|.
name|invoke
argument_list|(
name|sObjectBase
argument_list|,
operator|new
name|Object
index|[]
block|{
literal|null
block|}
argument_list|)
expr_stmt|;
return|return
name|value
return|;
block|}
catch|catch
parameter_list|(
name|NoSuchMethodException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"SObject %s does not have a field %s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
name|propertyName
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|InvocationTargetException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Error getting/setting value %s.%s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
name|propertyName
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|IllegalAccessException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"Error accessing value %s.%s"
argument_list|,
name|sObjectBase
operator|.
name|getClass
argument_list|()
operator|.
name|getSimpleName
argument_list|()
argument_list|,
name|propertyName
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
end_function

begin_comment
comment|// pre-process request message
end_comment

begin_function_decl
DECL|method|processRequest (Exchange exchange)
specifier|protected
specifier|abstract
name|void
name|processRequest
parameter_list|(
name|Exchange
name|exchange
parameter_list|)
throws|throws
name|SalesforceException
function_decl|;
end_function_decl

begin_comment
comment|// get request stream from In message
end_comment

begin_function_decl
DECL|method|getRequestStream (Exchange exchange)
specifier|protected
specifier|abstract
name|InputStream
name|getRequestStream
parameter_list|(
name|Exchange
name|exchange
parameter_list|)
throws|throws
name|SalesforceException
function_decl|;
end_function_decl

begin_comment
comment|/**      * Returns {@link InputStream} to serialized form of the given object.      *       * @param object      *            object to serialize      * @return stream to read serialized object from      */
end_comment

begin_function_decl
DECL|method|getRequestStream (Message in, Object object)
specifier|protected
specifier|abstract
name|InputStream
name|getRequestStream
parameter_list|(
name|Message
name|in
parameter_list|,
name|Object
name|object
parameter_list|)
throws|throws
name|SalesforceException
function_decl|;
end_function_decl

begin_function
DECL|method|setResponseClass (Exchange exchange, String sObjectName)
specifier|private
name|void
name|setResponseClass
parameter_list|(
name|Exchange
name|exchange
parameter_list|,
name|String
name|sObjectName
parameter_list|)
throws|throws
name|SalesforceException
block|{
comment|// nothing to do if using rawPayload
if|if
condition|(
name|rawPayload
condition|)
block|{
return|return;
block|}
name|Class
argument_list|<
name|?
argument_list|>
name|sObjectClass
decl_stmt|;
if|if
condition|(
name|sObjectName
operator|!=
literal|null
condition|)
block|{
comment|// lookup class from class map
name|sObjectClass
operator|=
name|classMap
operator|.
name|get
argument_list|(
name|sObjectName
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|==
name|sObjectClass
condition|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"No class found for SObject %s"
argument_list|,
name|sObjectName
argument_list|)
argument_list|,
literal|null
argument_list|)
throw|;
block|}
block|}
else|else
block|{
comment|// use custom response class property
specifier|final
name|String
name|className
init|=
name|getParameter
argument_list|(
name|SOBJECT_CLASS
argument_list|,
name|exchange
argument_list|,
name|IGNORE_BODY
argument_list|,
name|NOT_OPTIONAL
argument_list|)
decl_stmt|;
try|try
block|{
name|sObjectClass
operator|=
name|endpoint
operator|.
name|getComponent
argument_list|()
operator|.
name|getCamelContext
argument_list|()
operator|.
name|getClassResolver
argument_list|()
operator|.
name|resolveMandatoryClass
argument_list|(
name|className
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|ClassNotFoundException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|SalesforceException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"SObject class not found %s, %s"
argument_list|,
name|className
argument_list|,
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
name|exchange
operator|.
name|setProperty
argument_list|(
name|RESPONSE_CLASS
argument_list|,
name|sObjectClass
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
DECL|method|processWithResponseCallback (final Exchange exchange, final AsyncCallback callback)
specifier|final
name|ResponseCallback
name|processWithResponseCallback
parameter_list|(
specifier|final
name|Exchange
name|exchange
parameter_list|,
specifier|final
name|AsyncCallback
name|callback
parameter_list|)
block|{
return|return
parameter_list|(
name|response
parameter_list|,
name|headers
parameter_list|,
name|exception
parameter_list|)
lambda|->
name|processResponse
argument_list|(
name|exchange
argument_list|,
name|response
argument_list|,
name|headers
argument_list|,
name|exception
argument_list|,
name|callback
argument_list|)
return|;
block|}
end_function

begin_comment
comment|// process response entity and set out message in exchange
end_comment

begin_function_decl
DECL|method|processResponse (Exchange exchange, InputStream responseEntity, Map<String, String> headers, SalesforceException ex, AsyncCallback callback)
specifier|protected
specifier|abstract
name|void
name|processResponse
parameter_list|(
name|Exchange
name|exchange
parameter_list|,
name|InputStream
name|responseEntity
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|headers
parameter_list|,
name|SalesforceException
name|ex
parameter_list|,
name|AsyncCallback
name|callback
parameter_list|)
function_decl|;
end_function_decl

begin_function
DECL|method|shouldReport (SalesforceException ex)
specifier|final
name|boolean
name|shouldReport
parameter_list|(
name|SalesforceException
name|ex
parameter_list|)
block|{
return|return
operator|!
operator|(
name|ex
operator|instanceof
name|NoSuchSObjectException
operator|&&
name|notFoundBehaviour
operator|==
name|NotFoundBehaviour
operator|.
name|NULL
operator|)
return|;
block|}
end_function

unit|}
end_unit

