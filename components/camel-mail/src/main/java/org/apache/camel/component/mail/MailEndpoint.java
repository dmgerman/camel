begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.camel.component.mail
package|package
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|mail
package|;
end_package

begin_import
import|import
name|javax
operator|.
name|mail
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|mail
operator|.
name|search
operator|.
name|SearchTerm
import|;
end_import

begin_import
import|import
name|com
operator|.
name|sun
operator|.
name|mail
operator|.
name|imap
operator|.
name|SortTerm
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Consumer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Exchange
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Processor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|Producer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|spi
operator|.
name|HeaderFilterStrategy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|spi
operator|.
name|HeaderFilterStrategyAware
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|spi
operator|.
name|IdempotentRepository
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|spi
operator|.
name|UriEndpoint
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|spi
operator|.
name|UriParam
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|support
operator|.
name|ScheduledPollEndpoint
import|;
end_import

begin_comment
comment|/**  * To send or receive emails using imap/pop3 or smtp protocols.  */
end_comment

begin_class
annotation|@
name|UriEndpoint
argument_list|(
name|firstVersion
operator|=
literal|"1.0.0"
argument_list|,
name|scheme
operator|=
literal|"imap,imaps,pop3,pop3s,smtp,smtps"
argument_list|,
name|title
operator|=
literal|"IMAP,IMAPS,POP3,POP3S,SMTP,SMTPS"
argument_list|,
name|syntax
operator|=
literal|"imap:host:port"
argument_list|,
name|alternativeSyntax
operator|=
literal|"imap:username:password@host:port"
argument_list|,
name|label
operator|=
literal|"mail"
argument_list|)
DECL|class|MailEndpoint
specifier|public
class|class
name|MailEndpoint
extends|extends
name|ScheduledPollEndpoint
implements|implements
name|HeaderFilterStrategyAware
block|{
annotation|@
name|UriParam
argument_list|(
name|optionalPrefix
operator|=
literal|"consumer."
argument_list|,
name|defaultValue
operator|=
literal|""
operator|+
name|MailConsumer
operator|.
name|DEFAULT_CONSUMER_DELAY
argument_list|,
name|label
operator|=
literal|"consumer,scheduler"
argument_list|,
name|description
operator|=
literal|"Milliseconds before the next poll."
argument_list|)
DECL|field|delay
specifier|private
name|long
name|delay
init|=
name|MailConsumer
operator|.
name|DEFAULT_CONSUMER_DELAY
decl_stmt|;
annotation|@
name|UriParam
DECL|field|configuration
specifier|private
name|MailConfiguration
name|configuration
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"advanced"
argument_list|)
DECL|field|binding
specifier|private
name|MailBinding
name|binding
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"advanced"
argument_list|)
DECL|field|headerFilterStrategy
specifier|private
name|HeaderFilterStrategy
name|headerFilterStrategy
init|=
operator|new
name|MailHeaderFilterStrategy
argument_list|()
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"advanced"
argument_list|)
DECL|field|contentTypeResolver
specifier|private
name|ContentTypeResolver
name|contentTypeResolver
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer"
argument_list|)
DECL|field|maxMessagesPerPoll
specifier|private
name|int
name|maxMessagesPerPoll
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,filter"
argument_list|,
name|prefix
operator|=
literal|"searchTerm."
argument_list|,
name|multiValue
operator|=
literal|true
argument_list|)
DECL|field|searchTerm
specifier|private
name|SearchTerm
name|searchTerm
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,sort"
argument_list|,
name|javaType
operator|=
literal|"java.lang.String"
argument_list|)
DECL|field|sortTerm
specifier|private
name|SortTerm
index|[]
name|sortTerm
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,advanced"
argument_list|)
DECL|field|postProcessAction
specifier|private
name|MailBoxPostProcessAction
name|postProcessAction
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,filter"
argument_list|)
DECL|field|idempotentRepository
specifier|private
name|IdempotentRepository
name|idempotentRepository
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,filter"
argument_list|,
name|defaultValue
operator|=
literal|"true"
argument_list|)
DECL|field|idempotentRepositoryRemoveOnCommit
specifier|private
name|boolean
name|idempotentRepositoryRemoveOnCommit
init|=
literal|true
decl_stmt|;
annotation|@
name|UriParam
argument_list|(
name|label
operator|=
literal|"consumer,advanced"
argument_list|)
DECL|field|mailUidGenerator
specifier|private
name|MailUidGenerator
name|mailUidGenerator
init|=
operator|new
name|DefaultMailUidGenerator
argument_list|()
decl_stmt|;
DECL|method|MailEndpoint ()
specifier|public
name|MailEndpoint
parameter_list|()
block|{
name|this
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
DECL|method|MailEndpoint (String endpointUri)
specifier|public
name|MailEndpoint
parameter_list|(
name|String
name|endpointUri
parameter_list|)
block|{
name|this
argument_list|(
name|endpointUri
argument_list|,
literal|null
argument_list|,
operator|new
name|MailConfiguration
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|MailEndpoint (String uri, MailComponent component, MailConfiguration configuration)
specifier|public
name|MailEndpoint
parameter_list|(
name|String
name|uri
parameter_list|,
name|MailComponent
name|component
parameter_list|,
name|MailConfiguration
name|configuration
parameter_list|)
block|{
name|super
argument_list|(
name|uri
argument_list|,
name|component
argument_list|)
expr_stmt|;
name|this
operator|.
name|configuration
operator|=
name|configuration
expr_stmt|;
comment|// ScheduledPollConsumer default delay is 500 millis and that is too often for polling a mailbox,
comment|// so we override with a new default value. End user can override this value by providing a consumer.delay parameter
name|setDelay
argument_list|(
name|MailConsumer
operator|.
name|DEFAULT_CONSUMER_DELAY
argument_list|)
expr_stmt|;
block|}
DECL|method|createProducer ()
specifier|public
name|Producer
name|createProducer
parameter_list|()
throws|throws
name|Exception
block|{
name|JavaMailSender
name|sender
init|=
name|configuration
operator|.
name|getJavaMailSender
argument_list|()
decl_stmt|;
if|if
condition|(
name|sender
operator|==
literal|null
condition|)
block|{
comment|// use default mail sender
name|sender
operator|=
name|configuration
operator|.
name|createJavaMailSender
argument_list|()
expr_stmt|;
block|}
return|return
name|createProducer
argument_list|(
name|sender
argument_list|)
return|;
block|}
comment|/**      * Creates a producer using the given sender      */
DECL|method|createProducer (JavaMailSender sender)
specifier|public
name|Producer
name|createProducer
parameter_list|(
name|JavaMailSender
name|sender
parameter_list|)
throws|throws
name|Exception
block|{
return|return
operator|new
name|MailProducer
argument_list|(
name|this
argument_list|,
name|sender
argument_list|)
return|;
block|}
DECL|method|createConsumer (Processor processor)
specifier|public
name|Consumer
name|createConsumer
parameter_list|(
name|Processor
name|processor
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|configuration
operator|.
name|getProtocol
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"smtp"
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Protocol "
operator|+
name|configuration
operator|.
name|getProtocol
argument_list|()
operator|+
literal|" cannot be used for a MailConsumer. Please use another protocol such as pop3 or imap."
argument_list|)
throw|;
block|}
comment|// must use java mail sender impl as we need to get hold of a mail session
name|JavaMailSender
name|sender
init|=
name|configuration
operator|.
name|createJavaMailSender
argument_list|()
decl_stmt|;
return|return
name|createConsumer
argument_list|(
name|processor
argument_list|,
name|sender
argument_list|)
return|;
block|}
comment|/**      * Creates a consumer using the given processor and sender      */
DECL|method|createConsumer (Processor processor, JavaMailSender sender)
specifier|public
name|Consumer
name|createConsumer
parameter_list|(
name|Processor
name|processor
parameter_list|,
name|JavaMailSender
name|sender
parameter_list|)
throws|throws
name|Exception
block|{
name|MailConsumer
name|answer
init|=
operator|new
name|MailConsumer
argument_list|(
name|this
argument_list|,
name|processor
argument_list|,
name|sender
argument_list|)
decl_stmt|;
name|answer
operator|.
name|setHandleFailedMessage
argument_list|(
name|configuration
operator|.
name|isHandleFailedMessage
argument_list|()
argument_list|)
expr_stmt|;
name|answer
operator|.
name|setSkipFailedMessage
argument_list|(
name|configuration
operator|.
name|isSkipFailedMessage
argument_list|()
argument_list|)
expr_stmt|;
name|answer
operator|.
name|setMaxMessagesPerPoll
argument_list|(
name|getMaxMessagesPerPoll
argument_list|()
argument_list|)
expr_stmt|;
name|configureConsumer
argument_list|(
name|answer
argument_list|)
expr_stmt|;
return|return
name|answer
return|;
block|}
DECL|method|isSingleton ()
specifier|public
name|boolean
name|isSingleton
parameter_list|()
block|{
return|return
literal|false
return|;
block|}
DECL|method|createExchange (Message message)
specifier|public
name|Exchange
name|createExchange
parameter_list|(
name|Message
name|message
parameter_list|)
block|{
name|Exchange
name|exchange
init|=
name|super
operator|.
name|createExchange
argument_list|()
decl_stmt|;
name|exchange
operator|.
name|setProperty
argument_list|(
name|Exchange
operator|.
name|BINDING
argument_list|,
name|getBinding
argument_list|()
argument_list|)
expr_stmt|;
name|exchange
operator|.
name|setIn
argument_list|(
operator|new
name|MailMessage
argument_list|(
name|exchange
argument_list|,
name|message
argument_list|,
name|getConfiguration
argument_list|()
operator|.
name|isMapMailMessage
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|exchange
return|;
block|}
comment|// Properties
comment|// -------------------------------------------------------------------------
DECL|method|getBinding ()
specifier|public
name|MailBinding
name|getBinding
parameter_list|()
block|{
if|if
condition|(
name|binding
operator|==
literal|null
condition|)
block|{
name|binding
operator|=
operator|new
name|MailBinding
argument_list|(
name|headerFilterStrategy
argument_list|,
name|contentTypeResolver
argument_list|)
expr_stmt|;
block|}
return|return
name|binding
return|;
block|}
comment|/**      * Sets the binding used to convert from a Camel message to and from a Mail message      */
DECL|method|setBinding (MailBinding binding)
specifier|public
name|void
name|setBinding
parameter_list|(
name|MailBinding
name|binding
parameter_list|)
block|{
name|this
operator|.
name|binding
operator|=
name|binding
expr_stmt|;
block|}
DECL|method|getConfiguration ()
specifier|public
name|MailConfiguration
name|getConfiguration
parameter_list|()
block|{
return|return
name|configuration
return|;
block|}
comment|/**      * Sets the Mail configuration      */
DECL|method|setConfiguration (MailConfiguration configuration)
specifier|public
name|void
name|setConfiguration
parameter_list|(
name|MailConfiguration
name|configuration
parameter_list|)
block|{
name|this
operator|.
name|configuration
operator|=
name|configuration
expr_stmt|;
block|}
DECL|method|getHeaderFilterStrategy ()
specifier|public
name|HeaderFilterStrategy
name|getHeaderFilterStrategy
parameter_list|()
block|{
return|return
name|headerFilterStrategy
return|;
block|}
comment|/**      * To use a custom {@link org.apache.camel.spi.HeaderFilterStrategy} to filter headers.      */
DECL|method|setHeaderFilterStrategy (HeaderFilterStrategy headerFilterStrategy)
specifier|public
name|void
name|setHeaderFilterStrategy
parameter_list|(
name|HeaderFilterStrategy
name|headerFilterStrategy
parameter_list|)
block|{
name|this
operator|.
name|headerFilterStrategy
operator|=
name|headerFilterStrategy
expr_stmt|;
block|}
DECL|method|getContentTypeResolver ()
specifier|public
name|ContentTypeResolver
name|getContentTypeResolver
parameter_list|()
block|{
return|return
name|contentTypeResolver
return|;
block|}
comment|/**      * Resolver to determine Content-Type for file attachments.      */
DECL|method|setContentTypeResolver (ContentTypeResolver contentTypeResolver)
specifier|public
name|void
name|setContentTypeResolver
parameter_list|(
name|ContentTypeResolver
name|contentTypeResolver
parameter_list|)
block|{
name|this
operator|.
name|contentTypeResolver
operator|=
name|contentTypeResolver
expr_stmt|;
block|}
DECL|method|getMaxMessagesPerPoll ()
specifier|public
name|int
name|getMaxMessagesPerPoll
parameter_list|()
block|{
return|return
name|maxMessagesPerPoll
return|;
block|}
comment|/**      * Specifies the maximum number of messages to gather per poll. By default, no maximum is set.      * Can be used to set a limit of e.g. 1000 to avoid downloading thousands of files when the server starts up.      * Set a value of 0 or negative to disable this option.      */
DECL|method|setMaxMessagesPerPoll (int maxMessagesPerPoll)
specifier|public
name|void
name|setMaxMessagesPerPoll
parameter_list|(
name|int
name|maxMessagesPerPoll
parameter_list|)
block|{
name|this
operator|.
name|maxMessagesPerPoll
operator|=
name|maxMessagesPerPoll
expr_stmt|;
block|}
DECL|method|getSearchTerm ()
specifier|public
name|SearchTerm
name|getSearchTerm
parameter_list|()
block|{
return|return
name|searchTerm
return|;
block|}
comment|/**      * Refers to a {@link javax.mail.search.SearchTerm} which allows to filter mails based on search criteria such as subject, body, from, sent after a certain date etc.      */
DECL|method|setSearchTerm (SearchTerm searchTerm)
specifier|public
name|void
name|setSearchTerm
parameter_list|(
name|SearchTerm
name|searchTerm
parameter_list|)
block|{
name|this
operator|.
name|searchTerm
operator|=
name|searchTerm
expr_stmt|;
block|}
DECL|method|getSortTerm ()
specifier|public
name|SortTerm
index|[]
name|getSortTerm
parameter_list|()
block|{
return|return
name|sortTerm
operator|==
literal|null
condition|?
literal|null
else|:
name|sortTerm
operator|.
name|clone
argument_list|()
return|;
block|}
comment|/**      * Sorting order for messages. Only natively supported for IMAP. Emulated to some degree when using POP3      * or when IMAP server does not have the SORT capability.      */
DECL|method|setSortTerm (SortTerm[] sortTerm)
specifier|public
name|void
name|setSortTerm
parameter_list|(
name|SortTerm
index|[]
name|sortTerm
parameter_list|)
block|{
name|this
operator|.
name|sortTerm
operator|=
name|sortTerm
operator|==
literal|null
condition|?
literal|null
else|:
name|sortTerm
operator|.
name|clone
argument_list|()
expr_stmt|;
block|}
DECL|method|getPostProcessAction ()
specifier|public
name|MailBoxPostProcessAction
name|getPostProcessAction
parameter_list|()
block|{
return|return
name|postProcessAction
return|;
block|}
comment|/**      * Refers to an {@link MailBoxPostProcessAction} for doing post processing tasks on the mailbox once the normal processing ended.      */
DECL|method|setPostProcessAction (MailBoxPostProcessAction postProcessAction)
specifier|public
name|void
name|setPostProcessAction
parameter_list|(
name|MailBoxPostProcessAction
name|postProcessAction
parameter_list|)
block|{
name|this
operator|.
name|postProcessAction
operator|=
name|postProcessAction
expr_stmt|;
block|}
DECL|method|getIdempotentRepository ()
specifier|public
name|IdempotentRepository
name|getIdempotentRepository
parameter_list|()
block|{
return|return
name|idempotentRepository
return|;
block|}
comment|/**      * A pluggable repository org.apache.camel.spi.IdempotentRepository which allows to cluster      * consuming from the same mailbox, and let the repository coordinate whether a mail message      * is valid for the consumer to process.      *<p/>      * By default no repository is in use.      */
DECL|method|setIdempotentRepository (IdempotentRepository idempotentRepository)
specifier|public
name|void
name|setIdempotentRepository
parameter_list|(
name|IdempotentRepository
name|idempotentRepository
parameter_list|)
block|{
name|this
operator|.
name|idempotentRepository
operator|=
name|idempotentRepository
expr_stmt|;
block|}
DECL|method|isIdempotentRepositoryRemoveOnCommit ()
specifier|public
name|boolean
name|isIdempotentRepositoryRemoveOnCommit
parameter_list|()
block|{
return|return
name|idempotentRepositoryRemoveOnCommit
return|;
block|}
comment|/**      * When using idempotent repository, then when the mail message has been successfully processed and      * is committed, should the message id be removed from the idempotent repository (default) or      * be kept in the repository.      *<p/>      * By default its assumed the message id is unique and has no value to be kept in the repository,      * because the mail message will be marked as seen/moved or deleted to prevent it from being      * consumed again. And therefore having the message id stored in the idempotent repository has      * little value. However this option allows to store the message id, for whatever reason you may have.      */
DECL|method|setIdempotentRepositoryRemoveOnCommit (boolean idempotentRepositoryRemoveOnCommit)
specifier|public
name|void
name|setIdempotentRepositoryRemoveOnCommit
parameter_list|(
name|boolean
name|idempotentRepositoryRemoveOnCommit
parameter_list|)
block|{
name|this
operator|.
name|idempotentRepositoryRemoveOnCommit
operator|=
name|idempotentRepositoryRemoveOnCommit
expr_stmt|;
block|}
DECL|method|getMailUidGenerator ()
specifier|public
name|MailUidGenerator
name|getMailUidGenerator
parameter_list|()
block|{
return|return
name|mailUidGenerator
return|;
block|}
comment|/**      * A pluggable {@link MailUidGenerator} that allows to use custom logic to generate UUID of the mail message.      */
DECL|method|setMailUidGenerator (MailUidGenerator mailUidGenerator)
specifier|public
name|void
name|setMailUidGenerator
parameter_list|(
name|MailUidGenerator
name|mailUidGenerator
parameter_list|)
block|{
name|this
operator|.
name|mailUidGenerator
operator|=
name|mailUidGenerator
expr_stmt|;
block|}
comment|/**      * Milliseconds before the next poll.      */
annotation|@
name|Override
DECL|method|setDelay (long delay)
specifier|public
name|void
name|setDelay
parameter_list|(
name|long
name|delay
parameter_list|)
block|{
name|super
operator|.
name|setDelay
argument_list|(
name|delay
argument_list|)
expr_stmt|;
name|this
operator|.
name|delay
operator|=
name|delay
expr_stmt|;
block|}
block|}
end_class

end_unit

