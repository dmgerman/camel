begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
DECL|package|org.apache.camel.test.junit.rule.mllp
package|package
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|test
operator|.
name|junit
operator|.
name|rule
operator|.
name|mllp
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|BindException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|ServerSocket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|Socket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|SocketException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|SocketTimeoutException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|camel
operator|.
name|component
operator|.
name|mllp
operator|.
name|MllpProtocolConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|rules
operator|.
name|ExternalResource
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * MLLP Test Server packaged as a JUnit Rule  *  * The server can be configured to simulate a large number of error conditions.  */
end_comment

begin_class
DECL|class|MllpServerResource
specifier|public
class|class
name|MllpServerResource
extends|extends
name|ExternalResource
block|{
DECL|field|log
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|listenHost
name|String
name|listenHost
decl_stmt|;
DECL|field|listenPort
name|int
name|listenPort
decl_stmt|;
DECL|field|backlog
name|int
name|backlog
init|=
literal|5
decl_stmt|;
DECL|field|counter
name|int
name|counter
init|=
literal|1
decl_stmt|;
DECL|field|active
name|boolean
name|active
init|=
literal|true
decl_stmt|;
DECL|field|delayBeforeStartOfBlock
name|int
name|delayBeforeStartOfBlock
decl_stmt|;
DECL|field|delayBeforeAcknowledgement
name|int
name|delayBeforeAcknowledgement
decl_stmt|;
DECL|field|delayDuringAcknowledgement
name|int
name|delayDuringAcknowledgement
decl_stmt|;
DECL|field|delayAfterAcknowledgement
name|int
name|delayAfterAcknowledgement
decl_stmt|;
DECL|field|delayAfterEndOfBlock
name|int
name|delayAfterEndOfBlock
decl_stmt|;
DECL|field|excludeStartOfBlockModulus
name|int
name|excludeStartOfBlockModulus
decl_stmt|;
DECL|field|excludeEndOfBlockModulus
name|int
name|excludeEndOfBlockModulus
decl_stmt|;
DECL|field|excludeEndOfDataModulus
name|int
name|excludeEndOfDataModulus
decl_stmt|;
DECL|field|excludeAcknowledgementModulus
name|int
name|excludeAcknowledgementModulus
decl_stmt|;
DECL|field|sendOutOfBandDataModulus
name|int
name|sendOutOfBandDataModulus
decl_stmt|;
DECL|field|closeSocketBeforeAcknowledgementModulus
name|int
name|closeSocketBeforeAcknowledgementModulus
decl_stmt|;
DECL|field|closeSocketAfterAcknowledgementModulus
name|int
name|closeSocketAfterAcknowledgementModulus
decl_stmt|;
DECL|field|resetSocketBeforeAcknowledgementModulus
name|int
name|resetSocketBeforeAcknowledgementModulus
decl_stmt|;
DECL|field|resetSocketAfterAcknowledgementModulus
name|int
name|resetSocketAfterAcknowledgementModulus
decl_stmt|;
DECL|field|sendApplicationRejectAcknowledgementModulus
name|int
name|sendApplicationRejectAcknowledgementModulus
decl_stmt|;
DECL|field|sendApplicationErrorAcknowledgementModulus
name|int
name|sendApplicationErrorAcknowledgementModulus
decl_stmt|;
DECL|field|sendApplicationRejectAcknowledgementPattern
name|Pattern
name|sendApplicationRejectAcknowledgementPattern
decl_stmt|;
DECL|field|sendApplicationErrorAcknowledgementPattern
name|Pattern
name|sendApplicationErrorAcknowledgementPattern
decl_stmt|;
DECL|field|acknowledgementString
name|String
name|acknowledgementString
decl_stmt|;
DECL|field|acceptSocketThread
name|AcceptSocketThread
name|acceptSocketThread
decl_stmt|;
DECL|method|MllpServerResource ()
specifier|public
name|MllpServerResource
parameter_list|()
block|{     }
DECL|method|MllpServerResource (int listenPort)
specifier|public
name|MllpServerResource
parameter_list|(
name|int
name|listenPort
parameter_list|)
block|{
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
block|}
DECL|method|MllpServerResource (int listenPort, int backlog)
specifier|public
name|MllpServerResource
parameter_list|(
name|int
name|listenPort
parameter_list|,
name|int
name|backlog
parameter_list|)
block|{
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
name|this
operator|.
name|backlog
operator|=
name|backlog
expr_stmt|;
block|}
DECL|method|MllpServerResource (String listenHost, int listenPort)
specifier|public
name|MllpServerResource
parameter_list|(
name|String
name|listenHost
parameter_list|,
name|int
name|listenPort
parameter_list|)
block|{
name|this
operator|.
name|listenHost
operator|=
name|listenHost
expr_stmt|;
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
block|}
DECL|method|MllpServerResource (String listenHost, int listenPort, int backlog)
specifier|public
name|MllpServerResource
parameter_list|(
name|String
name|listenHost
parameter_list|,
name|int
name|listenPort
parameter_list|,
name|int
name|backlog
parameter_list|)
block|{
name|this
operator|.
name|listenHost
operator|=
name|listenHost
expr_stmt|;
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
name|this
operator|.
name|backlog
operator|=
name|backlog
expr_stmt|;
block|}
DECL|method|getListenHost ()
specifier|public
name|String
name|getListenHost
parameter_list|()
block|{
return|return
name|listenHost
return|;
block|}
DECL|method|setListenHost (String listenHost)
specifier|public
name|void
name|setListenHost
parameter_list|(
name|String
name|listenHost
parameter_list|)
block|{
name|this
operator|.
name|listenHost
operator|=
name|listenHost
expr_stmt|;
block|}
DECL|method|getListenPort ()
specifier|public
name|int
name|getListenPort
parameter_list|()
block|{
return|return
name|listenPort
return|;
block|}
DECL|method|setListenPort (int listenPort)
specifier|public
name|void
name|setListenPort
parameter_list|(
name|int
name|listenPort
parameter_list|)
block|{
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
block|}
DECL|method|getBacklog ()
specifier|public
name|int
name|getBacklog
parameter_list|()
block|{
return|return
name|backlog
return|;
block|}
DECL|method|setBacklog (int backlog)
specifier|public
name|void
name|setBacklog
parameter_list|(
name|int
name|backlog
parameter_list|)
block|{
name|this
operator|.
name|backlog
operator|=
name|backlog
expr_stmt|;
block|}
DECL|method|startup ()
specifier|public
name|void
name|startup
parameter_list|()
throws|throws
name|IOException
block|{
name|this
operator|.
name|active
operator|=
literal|true
expr_stmt|;
if|if
condition|(
literal|null
operator|!=
name|listenHost
condition|)
block|{
name|acceptSocketThread
operator|=
operator|new
name|AcceptSocketThread
argument_list|(
name|listenHost
argument_list|,
name|listenPort
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|acceptSocketThread
operator|=
operator|new
name|AcceptSocketThread
argument_list|(
name|listenPort
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
name|listenHost
operator|=
name|acceptSocketThread
operator|.
name|getListenHost
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
literal|0
operator|>=
name|listenPort
condition|)
block|{
name|listenPort
operator|=
name|acceptSocketThread
operator|.
name|listenPort
expr_stmt|;
block|}
name|acceptSocketThread
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|acceptSocketThread
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
DECL|method|shutdown ()
specifier|public
name|void
name|shutdown
parameter_list|()
block|{
name|this
operator|.
name|active
operator|=
literal|false
expr_stmt|;
if|if
condition|(
name|acceptSocketThread
operator|!=
literal|null
condition|)
block|{
name|acceptSocketThread
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|acceptSocketThread
operator|=
literal|null
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|before ()
specifier|protected
name|void
name|before
parameter_list|()
throws|throws
name|Throwable
block|{
name|startup
argument_list|()
expr_stmt|;
name|super
operator|.
name|before
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
DECL|method|after ()
specifier|protected
name|void
name|after
parameter_list|()
block|{
name|super
operator|.
name|after
argument_list|()
expr_stmt|;
name|shutdown
argument_list|()
expr_stmt|;
block|}
DECL|method|interrupt ()
specifier|public
name|void
name|interrupt
parameter_list|()
block|{
name|acceptSocketThread
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
DECL|method|getDelayBeforeStartOfBlock ()
specifier|public
name|int
name|getDelayBeforeStartOfBlock
parameter_list|()
block|{
return|return
name|delayBeforeStartOfBlock
return|;
block|}
DECL|method|setDelayBeforeStartOfBlock (int delayBeforeStartOfBlock)
specifier|public
name|void
name|setDelayBeforeStartOfBlock
parameter_list|(
name|int
name|delayBeforeStartOfBlock
parameter_list|)
block|{
name|this
operator|.
name|delayBeforeStartOfBlock
operator|=
name|delayBeforeStartOfBlock
expr_stmt|;
block|}
DECL|method|getDelayBeforeAcknowledgement ()
specifier|public
name|int
name|getDelayBeforeAcknowledgement
parameter_list|()
block|{
return|return
name|delayBeforeAcknowledgement
return|;
block|}
DECL|method|setDelayBeforeAcknowledgement (int delayBeforeAcknowledgement)
specifier|public
name|void
name|setDelayBeforeAcknowledgement
parameter_list|(
name|int
name|delayBeforeAcknowledgement
parameter_list|)
block|{
name|this
operator|.
name|delayBeforeAcknowledgement
operator|=
name|delayBeforeAcknowledgement
expr_stmt|;
block|}
DECL|method|getDelayDuringAcknowledgement ()
specifier|public
name|int
name|getDelayDuringAcknowledgement
parameter_list|()
block|{
return|return
name|delayDuringAcknowledgement
return|;
block|}
DECL|method|setDelayDuringAcknowledgement (int delayDuringAcknowledgement)
specifier|public
name|void
name|setDelayDuringAcknowledgement
parameter_list|(
name|int
name|delayDuringAcknowledgement
parameter_list|)
block|{
name|this
operator|.
name|delayDuringAcknowledgement
operator|=
name|delayDuringAcknowledgement
expr_stmt|;
block|}
DECL|method|getDelayAfterAcknowledgement ()
specifier|public
name|int
name|getDelayAfterAcknowledgement
parameter_list|()
block|{
return|return
name|delayAfterAcknowledgement
return|;
block|}
DECL|method|setDelayAfterAcknowledgement (int delayAfterAcknowledgement)
specifier|public
name|void
name|setDelayAfterAcknowledgement
parameter_list|(
name|int
name|delayAfterAcknowledgement
parameter_list|)
block|{
name|this
operator|.
name|delayAfterAcknowledgement
operator|=
name|delayAfterAcknowledgement
expr_stmt|;
block|}
DECL|method|getDelayAfterEndOfBlock ()
specifier|public
name|int
name|getDelayAfterEndOfBlock
parameter_list|()
block|{
return|return
name|delayAfterEndOfBlock
return|;
block|}
DECL|method|setDelayAfterEndOfBlock (int delayAfterEndOfBlock)
specifier|public
name|void
name|setDelayAfterEndOfBlock
parameter_list|(
name|int
name|delayAfterEndOfBlock
parameter_list|)
block|{
name|this
operator|.
name|delayAfterEndOfBlock
operator|=
name|delayAfterEndOfBlock
expr_stmt|;
block|}
DECL|method|sendApplicationRejectAcknowledgement (String hl7Message)
specifier|public
name|boolean
name|sendApplicationRejectAcknowledgement
parameter_list|(
name|String
name|hl7Message
parameter_list|)
block|{
return|return
name|evaluatePattern
argument_list|(
name|hl7Message
argument_list|,
name|this
operator|.
name|sendApplicationErrorAcknowledgementPattern
argument_list|)
return|;
block|}
DECL|method|sendApplicationErrorAcknowledgement (String hl7Message)
specifier|public
name|boolean
name|sendApplicationErrorAcknowledgement
parameter_list|(
name|String
name|hl7Message
parameter_list|)
block|{
return|return
name|evaluatePattern
argument_list|(
name|hl7Message
argument_list|,
name|this
operator|.
name|sendApplicationRejectAcknowledgementPattern
argument_list|)
return|;
block|}
DECL|method|sendApplicationRejectAcknowledgement (int messageCount)
specifier|public
name|boolean
name|sendApplicationRejectAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|this
operator|.
name|sendApplicationRejectAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|sendApplicationErrorAcknowledgement (int messageCount)
specifier|public
name|boolean
name|sendApplicationErrorAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|this
operator|.
name|sendApplicationErrorAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|excludeStartOfBlock (int messageCount)
specifier|public
name|boolean
name|excludeStartOfBlock
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|excludeStartOfBlockModulus
argument_list|)
return|;
block|}
DECL|method|excludeAcknowledgement (int messageCount)
specifier|public
name|boolean
name|excludeAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|excludeAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|excludeEndOfBlock (int messageCount)
specifier|public
name|boolean
name|excludeEndOfBlock
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|excludeEndOfBlockModulus
argument_list|)
return|;
block|}
DECL|method|excludeEndOfData (int messageCount)
specifier|public
name|boolean
name|excludeEndOfData
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|excludeEndOfDataModulus
argument_list|)
return|;
block|}
DECL|method|closeSocketBeforeAcknowledgement (int messageCount)
specifier|public
name|boolean
name|closeSocketBeforeAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|closeSocketBeforeAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|closeSocketAfterAcknowledgement (int messageCount)
specifier|public
name|boolean
name|closeSocketAfterAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|closeSocketAfterAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|resetSocketBeforeAcknowledgement (int messageCount)
specifier|public
name|boolean
name|resetSocketBeforeAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|resetSocketBeforeAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|resetSocketAfterAcknowledgement (int messageCount)
specifier|public
name|boolean
name|resetSocketAfterAcknowledgement
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|resetSocketAfterAcknowledgementModulus
argument_list|)
return|;
block|}
DECL|method|sendOutOfBandData (int messageCount)
specifier|public
name|boolean
name|sendOutOfBandData
parameter_list|(
name|int
name|messageCount
parameter_list|)
block|{
return|return
name|evaluateModulus
argument_list|(
name|messageCount
argument_list|,
name|sendOutOfBandDataModulus
argument_list|)
return|;
block|}
DECL|method|evaluateModulus (int messageCount, int modulus)
specifier|private
name|boolean
name|evaluateModulus
parameter_list|(
name|int
name|messageCount
parameter_list|,
name|int
name|modulus
parameter_list|)
block|{
switch|switch
condition|(
name|modulus
condition|)
block|{
case|case
literal|0
case|:
return|return
literal|false
return|;
case|case
literal|1
case|:
return|return
literal|true
return|;
default|default:
return|return
operator|(
name|messageCount
operator|%
name|modulus
operator|==
literal|0
operator|)
condition|?
literal|true
else|:
literal|false
return|;
block|}
block|}
DECL|method|evaluatePattern (String hl7Message, Pattern pattern)
specifier|private
name|boolean
name|evaluatePattern
parameter_list|(
name|String
name|hl7Message
parameter_list|,
name|Pattern
name|pattern
parameter_list|)
block|{
name|boolean
name|retValue
init|=
literal|false
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|pattern
operator|&&
name|pattern
operator|.
name|matcher
argument_list|(
name|hl7Message
argument_list|)
operator|.
name|matches
argument_list|()
condition|)
block|{
name|retValue
operator|=
literal|true
expr_stmt|;
block|}
return|return
name|retValue
return|;
block|}
DECL|method|isActive ()
specifier|public
name|boolean
name|isActive
parameter_list|()
block|{
return|return
name|active
return|;
block|}
DECL|method|setActive (boolean active)
specifier|public
name|void
name|setActive
parameter_list|(
name|boolean
name|active
parameter_list|)
block|{
name|this
operator|.
name|active
operator|=
name|active
expr_stmt|;
block|}
DECL|method|getExcludeStartOfBlockModulus ()
specifier|public
name|int
name|getExcludeStartOfBlockModulus
parameter_list|()
block|{
return|return
name|excludeStartOfBlockModulus
return|;
block|}
comment|/**      * Set the modulus used to determine when to include the START_OF_BLOCK portion of the MLLP Envelope.      *<p/>      * If this value is less than or equal to 0, the START_OF_BLOCK portion of the MLLP Envelope will always be      * included. If the value is 1, the START_OF_BLOCK portion of the MLLP Envelope will never be      * included. Otherwise, if the result of evaluating message availableByteCount % value is greater than 0, the      * START_OF_BLOCK portion of the MLLP Envelope will not be included.  Effectively leaving the      * START_OF_BLOCK portion of the MLLP Envelope out of every n-th message.      *      * @param excludeStartOfBlockModulus exclude on every n-th message 0 => Never excluded 1 => Always excluded      */
DECL|method|setExcludeStartOfBlockModulus (int excludeStartOfBlockModulus)
specifier|public
name|void
name|setExcludeStartOfBlockModulus
parameter_list|(
name|int
name|excludeStartOfBlockModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|excludeStartOfBlockModulus
condition|)
block|{
name|this
operator|.
name|excludeStartOfBlockModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|excludeStartOfBlockModulus
operator|=
name|excludeStartOfBlockModulus
expr_stmt|;
block|}
block|}
DECL|method|enableMllpEnvelope ()
specifier|public
name|void
name|enableMllpEnvelope
parameter_list|()
block|{
name|this
operator|.
name|setExcludeStartOfBlockModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfBlockModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfDataModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelopeStart ()
specifier|public
name|void
name|disableMllpEnvelopeStart
parameter_list|()
block|{
name|this
operator|.
name|disableMllpEnvelopeStart
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelopeStart (int mllpEnvelopeModulus)
specifier|public
name|void
name|disableMllpEnvelopeStart
parameter_list|(
name|int
name|mllpEnvelopeModulus
parameter_list|)
block|{
name|this
operator|.
name|setExcludeStartOfBlockModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelopeEnd ()
specifier|public
name|void
name|disableMllpEnvelopeEnd
parameter_list|()
block|{
name|this
operator|.
name|disableMllpEnvelope
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelopeEnd (int mllpEnvelopeModulus)
specifier|public
name|void
name|disableMllpEnvelopeEnd
parameter_list|(
name|int
name|mllpEnvelopeModulus
parameter_list|)
block|{
name|this
operator|.
name|setExcludeEndOfBlockModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfDataModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelope ()
specifier|public
name|void
name|disableMllpEnvelope
parameter_list|()
block|{
name|this
operator|.
name|disableMllpEnvelope
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|disableMllpEnvelope (int mllpEnvelopeModulus)
specifier|public
name|void
name|disableMllpEnvelope
parameter_list|(
name|int
name|mllpEnvelopeModulus
parameter_list|)
block|{
name|this
operator|.
name|setExcludeStartOfBlockModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfBlockModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfDataModulus
argument_list|(
name|mllpEnvelopeModulus
argument_list|)
expr_stmt|;
block|}
DECL|method|enableResponse ()
specifier|public
name|void
name|enableResponse
parameter_list|()
block|{
name|this
operator|.
name|setExcludeStartOfBlockModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeAcknowledgementModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfBlockModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfDataModulus
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
DECL|method|disableResponse ()
specifier|public
name|void
name|disableResponse
parameter_list|()
block|{
name|this
operator|.
name|disableResponse
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
DECL|method|disableResponse (int mllpResponseModulus)
specifier|public
name|void
name|disableResponse
parameter_list|(
name|int
name|mllpResponseModulus
parameter_list|)
block|{
name|this
operator|.
name|setExcludeStartOfBlockModulus
argument_list|(
name|mllpResponseModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeAcknowledgementModulus
argument_list|(
name|mllpResponseModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfBlockModulus
argument_list|(
name|mllpResponseModulus
argument_list|)
expr_stmt|;
name|this
operator|.
name|setExcludeEndOfDataModulus
argument_list|(
name|mllpResponseModulus
argument_list|)
expr_stmt|;
block|}
DECL|method|getExcludeEndOfBlockModulus ()
specifier|public
name|int
name|getExcludeEndOfBlockModulus
parameter_list|()
block|{
return|return
name|excludeEndOfBlockModulus
return|;
block|}
DECL|method|setExcludeEndOfBlockModulus (int excludeEndOfBlockModulus)
specifier|public
name|void
name|setExcludeEndOfBlockModulus
parameter_list|(
name|int
name|excludeEndOfBlockModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|excludeEndOfBlockModulus
condition|)
block|{
name|this
operator|.
name|excludeEndOfBlockModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|excludeEndOfBlockModulus
operator|=
name|excludeEndOfBlockModulus
expr_stmt|;
block|}
block|}
DECL|method|getExcludeEndOfDataModulus ()
specifier|public
name|int
name|getExcludeEndOfDataModulus
parameter_list|()
block|{
return|return
name|excludeEndOfDataModulus
return|;
block|}
DECL|method|setExcludeEndOfDataModulus (int excludeEndOfDataModulus)
specifier|public
name|void
name|setExcludeEndOfDataModulus
parameter_list|(
name|int
name|excludeEndOfDataModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|excludeEndOfDataModulus
condition|)
block|{
name|this
operator|.
name|excludeEndOfDataModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|excludeEndOfDataModulus
operator|=
name|excludeEndOfDataModulus
expr_stmt|;
block|}
block|}
DECL|method|getExcludeAcknowledgementModulus ()
specifier|public
name|int
name|getExcludeAcknowledgementModulus
parameter_list|()
block|{
return|return
name|excludeAcknowledgementModulus
return|;
block|}
DECL|method|setExcludeAcknowledgementModulus (int excludeAcknowledgementModulus)
specifier|public
name|void
name|setExcludeAcknowledgementModulus
parameter_list|(
name|int
name|excludeAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|excludeAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|excludeAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|excludeAcknowledgementModulus
operator|=
name|excludeAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getSendOutOfBandDataModulus ()
specifier|public
name|int
name|getSendOutOfBandDataModulus
parameter_list|()
block|{
return|return
name|sendOutOfBandDataModulus
return|;
block|}
DECL|method|setSendOutOfBandDataModulus (int sendOutOfBandDataModulus)
specifier|public
name|void
name|setSendOutOfBandDataModulus
parameter_list|(
name|int
name|sendOutOfBandDataModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|sendOutOfBandDataModulus
condition|)
block|{
name|this
operator|.
name|sendOutOfBandDataModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|sendOutOfBandDataModulus
operator|=
name|sendOutOfBandDataModulus
expr_stmt|;
block|}
block|}
DECL|method|getCloseSocketBeforeAcknowledgementModulus ()
specifier|public
name|int
name|getCloseSocketBeforeAcknowledgementModulus
parameter_list|()
block|{
return|return
name|closeSocketBeforeAcknowledgementModulus
return|;
block|}
DECL|method|setCloseSocketBeforeAcknowledgementModulus (int closeSocketBeforeAcknowledgementModulus)
specifier|public
name|void
name|setCloseSocketBeforeAcknowledgementModulus
parameter_list|(
name|int
name|closeSocketBeforeAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|closeSocketBeforeAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|closeSocketBeforeAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|closeSocketBeforeAcknowledgementModulus
operator|=
name|closeSocketBeforeAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getCloseSocketAfterAcknowledgementModulus ()
specifier|public
name|int
name|getCloseSocketAfterAcknowledgementModulus
parameter_list|()
block|{
return|return
name|closeSocketAfterAcknowledgementModulus
return|;
block|}
DECL|method|setCloseSocketAfterAcknowledgementModulus (int closeSocketAfterAcknowledgementModulus)
specifier|public
name|void
name|setCloseSocketAfterAcknowledgementModulus
parameter_list|(
name|int
name|closeSocketAfterAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|closeSocketAfterAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|closeSocketAfterAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|closeSocketAfterAcknowledgementModulus
operator|=
name|closeSocketAfterAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getResetSocketBeforeAcknowledgementModulus ()
specifier|public
name|int
name|getResetSocketBeforeAcknowledgementModulus
parameter_list|()
block|{
return|return
name|resetSocketBeforeAcknowledgementModulus
return|;
block|}
DECL|method|setResetSocketBeforeAcknowledgementModulus (int resetSocketBeforeAcknowledgementModulus)
specifier|public
name|void
name|setResetSocketBeforeAcknowledgementModulus
parameter_list|(
name|int
name|resetSocketBeforeAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|resetSocketBeforeAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|resetSocketBeforeAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|resetSocketBeforeAcknowledgementModulus
operator|=
name|resetSocketBeforeAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getResetSocketAfterAcknowledgementModulus ()
specifier|public
name|int
name|getResetSocketAfterAcknowledgementModulus
parameter_list|()
block|{
return|return
name|resetSocketAfterAcknowledgementModulus
return|;
block|}
DECL|method|setResetSocketAfterAcknowledgementModulus (int resetSocketAfterAcknowledgementModulus)
specifier|public
name|void
name|setResetSocketAfterAcknowledgementModulus
parameter_list|(
name|int
name|resetSocketAfterAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|resetSocketAfterAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|resetSocketAfterAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|resetSocketAfterAcknowledgementModulus
operator|=
name|resetSocketAfterAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getSendApplicationRejectAcknowledgementModulus ()
specifier|public
name|int
name|getSendApplicationRejectAcknowledgementModulus
parameter_list|()
block|{
return|return
name|sendApplicationRejectAcknowledgementModulus
return|;
block|}
DECL|method|setSendApplicationRejectAcknowledgementModulus (int sendApplicationRejectAcknowledgementModulus)
specifier|public
name|void
name|setSendApplicationRejectAcknowledgementModulus
parameter_list|(
name|int
name|sendApplicationRejectAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|sendApplicationRejectAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|sendApplicationRejectAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|sendApplicationRejectAcknowledgementModulus
operator|=
name|sendApplicationRejectAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getSendApplicationErrorAcknowledgementModulus ()
specifier|public
name|int
name|getSendApplicationErrorAcknowledgementModulus
parameter_list|()
block|{
return|return
name|sendApplicationErrorAcknowledgementModulus
return|;
block|}
DECL|method|setSendApplicationErrorAcknowledgementModulus (int sendApplicationErrorAcknowledgementModulus)
specifier|public
name|void
name|setSendApplicationErrorAcknowledgementModulus
parameter_list|(
name|int
name|sendApplicationErrorAcknowledgementModulus
parameter_list|)
block|{
if|if
condition|(
literal|0
operator|>
name|sendApplicationErrorAcknowledgementModulus
condition|)
block|{
name|this
operator|.
name|sendApplicationErrorAcknowledgementModulus
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|this
operator|.
name|sendApplicationErrorAcknowledgementModulus
operator|=
name|sendApplicationErrorAcknowledgementModulus
expr_stmt|;
block|}
block|}
DECL|method|getSendApplicationRejectAcknowledgementPattern ()
specifier|public
name|Pattern
name|getSendApplicationRejectAcknowledgementPattern
parameter_list|()
block|{
return|return
name|sendApplicationRejectAcknowledgementPattern
return|;
block|}
DECL|method|setSendApplicationRejectAcknowledgementPattern (Pattern sendApplicationRejectAcknowledgementPattern)
specifier|public
name|void
name|setSendApplicationRejectAcknowledgementPattern
parameter_list|(
name|Pattern
name|sendApplicationRejectAcknowledgementPattern
parameter_list|)
block|{
name|this
operator|.
name|sendApplicationRejectAcknowledgementPattern
operator|=
name|sendApplicationRejectAcknowledgementPattern
expr_stmt|;
block|}
DECL|method|getSendApplicationErrorAcknowledgementPattern ()
specifier|public
name|Pattern
name|getSendApplicationErrorAcknowledgementPattern
parameter_list|()
block|{
return|return
name|sendApplicationErrorAcknowledgementPattern
return|;
block|}
DECL|method|setSendApplicationErrorAcknowledgementPattern (Pattern sendApplicationErrorAcknowledgementPattern)
specifier|public
name|void
name|setSendApplicationErrorAcknowledgementPattern
parameter_list|(
name|Pattern
name|sendApplicationErrorAcknowledgementPattern
parameter_list|)
block|{
name|this
operator|.
name|sendApplicationErrorAcknowledgementPattern
operator|=
name|sendApplicationErrorAcknowledgementPattern
expr_stmt|;
block|}
DECL|method|getAcknowledgementString ()
specifier|public
name|String
name|getAcknowledgementString
parameter_list|()
block|{
return|return
name|acknowledgementString
return|;
block|}
DECL|method|setAcknowledgementString (String acknowledgementString)
specifier|public
name|void
name|setAcknowledgementString
parameter_list|(
name|String
name|acknowledgementString
parameter_list|)
block|{
name|this
operator|.
name|acknowledgementString
operator|=
name|acknowledgementString
expr_stmt|;
block|}
DECL|method|getAcceptSocketThread ()
specifier|public
name|AcceptSocketThread
name|getAcceptSocketThread
parameter_list|()
block|{
return|return
name|acceptSocketThread
return|;
block|}
DECL|method|setAcceptSocketThread (AcceptSocketThread acceptSocketThread)
specifier|public
name|void
name|setAcceptSocketThread
parameter_list|(
name|AcceptSocketThread
name|acceptSocketThread
parameter_list|)
block|{
name|this
operator|.
name|acceptSocketThread
operator|=
name|acceptSocketThread
expr_stmt|;
block|}
DECL|method|checkClientConnections ()
specifier|public
name|void
name|checkClientConnections
parameter_list|()
block|{
if|if
condition|(
name|acceptSocketThread
operator|!=
literal|null
condition|)
block|{
name|acceptSocketThread
operator|.
name|checkClientConnections
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|closeClientConnections ()
specifier|public
name|void
name|closeClientConnections
parameter_list|()
block|{
if|if
condition|(
name|acceptSocketThread
operator|!=
literal|null
condition|)
block|{
name|acceptSocketThread
operator|.
name|closeClientConnections
argument_list|()
expr_stmt|;
block|}
block|}
DECL|method|resetClientConnections ()
specifier|public
name|void
name|resetClientConnections
parameter_list|()
block|{
if|if
condition|(
name|acceptSocketThread
operator|!=
literal|null
condition|)
block|{
name|acceptSocketThread
operator|.
name|resetClientConnections
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Generates a HL7 Application Acknowledgement      *      * @param hl7Message          HL7 message that is being acknowledged      * @param acknowledgementCode AA, AE or AR      *      * @return a HL7 Application Acknowledgement      */
DECL|method|generateAcknowledgement (String hl7Message, String acknowledgementCode)
specifier|protected
name|String
name|generateAcknowledgement
parameter_list|(
name|String
name|hl7Message
parameter_list|,
name|String
name|acknowledgementCode
parameter_list|)
block|{
specifier|final
name|String
name|defaulNackMessage
init|=
literal|"MSH|^~\\&|||||||NACK||P|2.2"
operator|+
name|MllpProtocolConstants
operator|.
name|SEGMENT_DELIMITER
operator|+
literal|"MSA|AR|"
operator|+
name|MllpProtocolConstants
operator|.
name|SEGMENT_DELIMITER
operator|+
name|MllpProtocolConstants
operator|.
name|MESSAGE_TERMINATOR
decl_stmt|;
if|if
condition|(
name|hl7Message
operator|==
literal|null
condition|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Invalid HL7 message for parsing operation. Please check your inputs"
argument_list|)
expr_stmt|;
return|return
name|defaulNackMessage
return|;
block|}
if|if
condition|(
operator|!
operator|(
literal|"AA"
operator|.
name|equals
argument_list|(
name|acknowledgementCode
argument_list|)
operator|||
literal|"AE"
operator|.
name|equals
argument_list|(
name|acknowledgementCode
argument_list|)
operator|||
literal|"AR"
operator|.
name|equals
argument_list|(
name|acknowledgementCode
argument_list|)
operator|)
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Acknowledgemnt Code must be AA, AE or AR: "
operator|+
name|acknowledgementCode
argument_list|)
throw|;
block|}
name|int
name|endOfMshSegment
init|=
name|hl7Message
operator|.
name|indexOf
argument_list|(
name|MllpProtocolConstants
operator|.
name|SEGMENT_DELIMITER
argument_list|)
decl_stmt|;
if|if
condition|(
operator|-
literal|1
operator|!=
name|endOfMshSegment
condition|)
block|{
name|String
name|mshSegment
init|=
name|hl7Message
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|endOfMshSegment
argument_list|)
decl_stmt|;
name|char
name|fieldSeparator
init|=
name|mshSegment
operator|.
name|charAt
argument_list|(
literal|3
argument_list|)
decl_stmt|;
name|String
name|fieldSeparatorPattern
init|=
name|Pattern
operator|.
name|quote
argument_list|(
literal|""
operator|+
name|fieldSeparator
argument_list|)
decl_stmt|;
name|String
index|[]
name|mshFields
init|=
name|mshSegment
operator|.
name|split
argument_list|(
name|fieldSeparatorPattern
argument_list|)
decl_stmt|;
if|if
condition|(
name|mshFields
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Failed to split MSH Segment into fields"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StringBuilder
name|ackBuilder
init|=
operator|new
name|StringBuilder
argument_list|(
name|mshSegment
operator|.
name|length
argument_list|()
operator|+
literal|25
argument_list|)
decl_stmt|;
comment|// Build the MSH Segment
name|ackBuilder
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|0
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|1
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|4
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|5
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|2
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|3
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|6
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|7
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
literal|"ACK"
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|8
index|]
operator|.
name|substring
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|9
init|;
name|i
operator|<
name|mshFields
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
name|ackBuilder
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
comment|// Empty fields at the end are not preserved by String.split, so preserve them
name|int
name|emptyFieldIndex
init|=
name|mshSegment
operator|.
name|length
argument_list|()
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|fieldSeparator
operator|==
name|mshSegment
operator|.
name|charAt
argument_list|(
name|mshSegment
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
condition|)
block|{
name|ackBuilder
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
expr_stmt|;
while|while
condition|(
name|emptyFieldIndex
operator|>=
literal|1
operator|&&
name|mshSegment
operator|.
name|charAt
argument_list|(
name|emptyFieldIndex
argument_list|)
operator|==
name|mshSegment
operator|.
name|charAt
argument_list|(
name|emptyFieldIndex
operator|-
literal|1
argument_list|)
condition|)
block|{
name|ackBuilder
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
expr_stmt|;
operator|--
name|emptyFieldIndex
expr_stmt|;
block|}
block|}
name|ackBuilder
operator|.
name|append
argument_list|(
name|MllpProtocolConstants
operator|.
name|SEGMENT_DELIMITER
argument_list|)
expr_stmt|;
comment|// Build the MSA Segment
name|ackBuilder
operator|.
name|append
argument_list|(
literal|"MSA"
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|acknowledgementCode
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|mshFields
index|[
literal|9
index|]
argument_list|)
operator|.
name|append
argument_list|(
name|fieldSeparator
argument_list|)
operator|.
name|append
argument_list|(
name|MllpProtocolConstants
operator|.
name|SEGMENT_DELIMITER
argument_list|)
expr_stmt|;
comment|// Terminate the message
name|ackBuilder
operator|.
name|append
argument_list|(
name|MllpProtocolConstants
operator|.
name|MESSAGE_TERMINATOR
argument_list|)
expr_stmt|;
return|return
name|ackBuilder
operator|.
name|toString
argument_list|()
return|;
block|}
block|}
else|else
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Failed to find the end of the  MSH Segment"
argument_list|)
expr_stmt|;
block|}
return|return
literal|null
return|;
block|}
comment|/**      * Nested class to accept TCP connections      */
DECL|class|AcceptSocketThread
class|class
name|AcceptSocketThread
extends|extends
name|Thread
block|{
DECL|field|bindTimeout
specifier|final
name|long
name|bindTimeout
init|=
literal|30000
decl_stmt|;
DECL|field|bindRetryDelay
specifier|final
name|long
name|bindRetryDelay
init|=
literal|1000
decl_stmt|;
DECL|field|log
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|serverSocket
name|ServerSocket
name|serverSocket
decl_stmt|;
DECL|field|clientSocketThreads
name|List
argument_list|<
name|ClientSocketThread
argument_list|>
name|clientSocketThreads
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
decl_stmt|;
DECL|field|listenHost
name|String
name|listenHost
decl_stmt|;
DECL|field|listenPort
name|int
name|listenPort
decl_stmt|;
DECL|field|backlog
name|int
name|backlog
init|=
literal|5
decl_stmt|;
DECL|field|acceptTimeout
name|int
name|acceptTimeout
init|=
literal|5000
decl_stmt|;
DECL|field|raiseExceptionOnAcceptTimeout
name|boolean
name|raiseExceptionOnAcceptTimeout
decl_stmt|;
DECL|method|AcceptSocketThread ()
name|AcceptSocketThread
parameter_list|()
throws|throws
name|IOException
block|{
name|bind
argument_list|()
expr_stmt|;
block|}
DECL|method|AcceptSocketThread (int listenPort)
name|AcceptSocketThread
parameter_list|(
name|int
name|listenPort
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
name|bind
argument_list|()
expr_stmt|;
block|}
DECL|method|AcceptSocketThread (int listenPort, int backlog)
name|AcceptSocketThread
parameter_list|(
name|int
name|listenPort
parameter_list|,
name|int
name|backlog
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
name|this
operator|.
name|backlog
operator|=
name|backlog
expr_stmt|;
name|bind
argument_list|()
expr_stmt|;
block|}
DECL|method|AcceptSocketThread (String listenHost, int listenPort, int backlog)
name|AcceptSocketThread
parameter_list|(
name|String
name|listenHost
parameter_list|,
name|int
name|listenPort
parameter_list|,
name|int
name|backlog
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|listenHost
operator|=
name|listenHost
expr_stmt|;
name|this
operator|.
name|listenPort
operator|=
name|listenPort
expr_stmt|;
name|this
operator|.
name|backlog
operator|=
name|backlog
expr_stmt|;
name|bind
argument_list|()
expr_stmt|;
block|}
comment|/**          * Open the TCP Listener          *          * @throws IOException          */
DECL|method|bind ()
specifier|private
name|void
name|bind
parameter_list|()
throws|throws
name|IOException
block|{
name|this
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|serverSocket
operator|=
operator|new
name|ServerSocket
argument_list|()
expr_stmt|;
comment|// Set TCP Parameters
name|serverSocket
operator|.
name|setSoTimeout
argument_list|(
name|acceptTimeout
argument_list|)
expr_stmt|;
name|serverSocket
operator|.
name|setReuseAddress
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|InetSocketAddress
name|listenAddress
decl_stmt|;
if|if
condition|(
literal|null
operator|!=
name|this
operator|.
name|listenHost
condition|)
block|{
name|listenAddress
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|this
operator|.
name|listenHost
argument_list|,
name|this
operator|.
name|listenPort
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|listenAddress
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|this
operator|.
name|listenPort
argument_list|)
expr_stmt|;
block|}
name|long
name|startTicks
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
while|while
condition|(
operator|!
name|serverSocket
operator|.
name|isBound
argument_list|()
condition|)
block|{
try|try
block|{
name|serverSocket
operator|.
name|bind
argument_list|(
name|listenAddress
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|BindException
name|bindEx
parameter_list|)
block|{
if|if
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|<
name|startTicks
operator|+
name|bindTimeout
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Unable to bind to {} - retrying in {} milliseconds"
argument_list|,
name|listenAddress
argument_list|,
name|bindRetryDelay
argument_list|)
expr_stmt|;
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|bindRetryDelay
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|interruptedEx
parameter_list|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Wait for bind retry was interrupted - rethrowing BindException"
argument_list|)
expr_stmt|;
throw|throw
name|bindEx
throw|;
block|}
block|}
block|}
block|}
if|if
condition|(
literal|0
operator|>=
name|this
operator|.
name|listenPort
condition|)
block|{
name|this
operator|.
name|listenPort
operator|=
name|serverSocket
operator|.
name|getLocalPort
argument_list|()
expr_stmt|;
block|}
name|log
operator|.
name|info
argument_list|(
literal|"Opened TCP Listener on port {}"
argument_list|,
name|serverSocket
operator|.
name|getLocalPort
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|checkClientConnections ()
name|void
name|checkClientConnections
parameter_list|()
block|{
if|if
condition|(
name|clientSocketThreads
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ClientSocketThread
name|clientSocketThread
range|:
name|clientSocketThreads
control|)
block|{
name|clientSocketThread
operator|.
name|checkConnection
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|closeClientConnections ()
name|void
name|closeClientConnections
parameter_list|()
block|{
if|if
condition|(
name|clientSocketThreads
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ClientSocketThread
name|clientSocketThread
range|:
name|clientSocketThreads
control|)
block|{
name|clientSocketThread
operator|.
name|closeConnection
argument_list|()
expr_stmt|;
block|}
block|}
block|}
DECL|method|resetClientConnections ()
name|void
name|resetClientConnections
parameter_list|()
block|{
if|if
condition|(
name|clientSocketThreads
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ClientSocketThread
name|clientSocketThread
range|:
name|clientSocketThreads
control|)
block|{
name|clientSocketThread
operator|.
name|resetConnection
argument_list|()
expr_stmt|;
block|}
block|}
block|}
comment|/**          * Accept TCP connections and create ClientSocketThreads for them          */
annotation|@
name|Override
DECL|method|run ()
specifier|public
name|void
name|run
parameter_list|()
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Accepting connections on port {}"
argument_list|,
name|serverSocket
operator|.
name|getLocalPort
argument_list|()
argument_list|)
expr_stmt|;
name|this
operator|.
name|setName
argument_list|(
literal|"MllpServerResource$AcceptSocketThread - "
operator|+
name|serverSocket
operator|.
name|getLocalSocketAddress
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|isInterrupted
argument_list|()
operator|&&
name|serverSocket
operator|.
name|isBound
argument_list|()
operator|&&
operator|!
name|serverSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
name|Socket
name|clientSocket
init|=
literal|null
decl_stmt|;
try|try
block|{
name|clientSocket
operator|=
name|serverSocket
operator|.
name|accept
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SocketTimeoutException
name|timeoutEx
parameter_list|)
block|{
if|if
condition|(
name|raiseExceptionOnAcceptTimeout
condition|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceTimeoutException
argument_list|(
literal|"Timeout Accepting client connection"
argument_list|,
name|timeoutEx
argument_list|)
throw|;
block|}
name|log
operator|.
name|warn
argument_list|(
literal|"Timeout waiting for client connection"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SocketException
name|socketEx
parameter_list|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"SocketException encountered accepting client connection - ignoring"
argument_list|,
name|socketEx
argument_list|)
expr_stmt|;
if|if
condition|(
literal|null
operator|==
name|clientSocket
condition|)
block|{
continue|continue;
block|}
elseif|else
if|if
condition|(
operator|!
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|setSoLinger
argument_list|(
literal|true
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SocketException
name|soLingerEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring SocketException encountered when setting SO_LINGER in preparation of resetting client Socket"
argument_list|,
name|soLingerEx
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring IOException encountered when resetting client Socket"
argument_list|,
name|ioEx
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
else|else
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"Unexpected SocketException encountered accepting client connection"
argument_list|,
name|socketEx
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"Unexpected exception encountered accepting client connection"
argument_list|,
name|ex
argument_list|)
throw|;
block|}
if|if
condition|(
literal|null
operator|!=
name|clientSocket
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|setKeepAlive
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|clientSocket
operator|.
name|setTcpNoDelay
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|clientSocket
operator|.
name|setSoLinger
argument_list|(
literal|false
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|clientSocket
operator|.
name|setSoTimeout
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
name|ClientSocketThread
name|clientSocketThread
init|=
operator|new
name|ClientSocketThread
argument_list|(
name|clientSocket
argument_list|)
decl_stmt|;
name|clientSocketThread
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|clientSocketThread
operator|.
name|start
argument_list|()
expr_stmt|;
name|clientSocketThreads
operator|.
name|add
argument_list|(
name|clientSocketThread
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|unexpectedEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Unexpected exception encountered configuring client socket"
argument_list|)
expr_stmt|;
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ingoreEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Exceptiong encountered closing client socket after attempting to accept connection"
argument_list|,
name|ingoreEx
argument_list|)
expr_stmt|;
block|}
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"Unexpected exception encountered configuring client socket"
argument_list|,
name|unexpectedEx
argument_list|)
throw|;
block|}
block|}
block|}
name|log
operator|.
name|info
argument_list|(
literal|"No longer accepting connections - closing TCP Listener on port {}"
argument_list|,
name|serverSocket
operator|.
name|getLocalPort
argument_list|()
argument_list|)
expr_stmt|;
try|try
block|{
name|serverSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
name|log
operator|.
name|info
argument_list|(
literal|"Closed TCP Listener on port {}"
argument_list|,
name|serverSocket
operator|.
name|getLocalPort
argument_list|()
argument_list|)
expr_stmt|;
block|}
DECL|method|shutdown ()
specifier|public
name|void
name|shutdown
parameter_list|()
block|{
name|this
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
DECL|method|getListenHost ()
specifier|public
name|String
name|getListenHost
parameter_list|()
block|{
return|return
name|listenHost
return|;
block|}
DECL|method|getListenPort ()
specifier|public
name|int
name|getListenPort
parameter_list|()
block|{
return|return
name|listenPort
return|;
block|}
DECL|method|getBacklog ()
specifier|public
name|int
name|getBacklog
parameter_list|()
block|{
return|return
name|backlog
return|;
block|}
DECL|method|getAcceptTimeout ()
specifier|public
name|int
name|getAcceptTimeout
parameter_list|()
block|{
return|return
name|acceptTimeout
return|;
block|}
comment|/**          * Enable/disable a timeout while waiting for a TCP connection, in milliseconds. With this option set to a          * non-zero timeout, the AcceptSocketThread will block for only this amount of time while          * waiting for a tcp connection. If the timeout expires and raiseExceptionOnAcceptTimeout is set          * to true, a MllpJUnitResourceTimeoutException is raised. Otherwise, the AcceptSocketThread will          * continue to poll for new TCP connections.          *          * @param acceptTimeout the timeout in milliseconds - zero is interpreted as an infinite timeout          */
DECL|method|setAcceptTimeout (int acceptTimeout)
specifier|public
name|void
name|setAcceptTimeout
parameter_list|(
name|int
name|acceptTimeout
parameter_list|)
block|{
name|this
operator|.
name|acceptTimeout
operator|=
name|acceptTimeout
expr_stmt|;
block|}
DECL|method|isRaiseExceptionOnAcceptTimeout ()
specifier|public
name|boolean
name|isRaiseExceptionOnAcceptTimeout
parameter_list|()
block|{
return|return
name|raiseExceptionOnAcceptTimeout
return|;
block|}
comment|/**          * Enable/Disable the generation of MllpJUnitResourceTimeoutException if the ServerSocket.accept() call raises a SocketTimeoutException.          *          * @param raiseExceptionOnAcceptTimeout true enables exceptions on an accept timeout          */
DECL|method|setRaiseExceptionOnAcceptTimeout (boolean raiseExceptionOnAcceptTimeout)
specifier|public
name|void
name|setRaiseExceptionOnAcceptTimeout
parameter_list|(
name|boolean
name|raiseExceptionOnAcceptTimeout
parameter_list|)
block|{
name|this
operator|.
name|raiseExceptionOnAcceptTimeout
operator|=
name|raiseExceptionOnAcceptTimeout
expr_stmt|;
block|}
DECL|method|close ()
specifier|public
name|void
name|close
parameter_list|()
block|{          }
annotation|@
name|Override
DECL|method|interrupt ()
specifier|public
name|void
name|interrupt
parameter_list|()
block|{
for|for
control|(
name|ClientSocketThread
name|clientSocketThread
range|:
name|clientSocketThreads
control|)
block|{
name|clientSocketThread
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|serverSocket
operator|!=
literal|null
operator|&&
name|serverSocket
operator|.
name|isBound
argument_list|()
operator|&&
operator|!
name|serverSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
try|try
block|{
name|serverSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Exception encountered closing server socket on interrupt"
argument_list|,
name|ex
argument_list|)
expr_stmt|;
block|}
block|}
name|super
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**      * Nested class that handles the established TCP connections      */
DECL|class|ClientSocketThread
class|class
name|ClientSocketThread
extends|extends
name|Thread
block|{
DECL|field|log
name|Logger
name|log
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|this
operator|.
name|getClass
argument_list|()
argument_list|)
decl_stmt|;
DECL|field|clientSocket
name|Socket
name|clientSocket
decl_stmt|;
DECL|field|messageCounter
name|int
name|messageCounter
decl_stmt|;
DECL|method|ClientSocketThread (Socket clientSocket)
name|ClientSocketThread
parameter_list|(
name|Socket
name|clientSocket
parameter_list|)
block|{
name|this
operator|.
name|clientSocket
operator|=
name|clientSocket
expr_stmt|;
block|}
DECL|method|checkConnection ()
name|void
name|checkConnection
parameter_list|()
block|{
if|if
condition|(
name|clientSocket
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"checkConnection failed - clientSocket is null"
argument_list|)
throw|;
block|}
if|if
condition|(
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"checkConnection failed - clientSocket is closed"
argument_list|)
throw|;
block|}
if|if
condition|(
operator|!
name|clientSocket
operator|.
name|isConnected
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"checkConnection failed - clientSocket is not connected"
argument_list|)
throw|;
block|}
try|try
block|{
if|if
condition|(
name|MllpProtocolConstants
operator|.
name|END_OF_STREAM
operator|==
name|clientSocket
operator|.
name|getInputStream
argument_list|()
operator|.
name|read
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"checkConnection failed - read() returned END_OF_STREAM"
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"checkConnection failed - read() failure"
argument_list|,
name|ioEx
argument_list|)
throw|;
block|}
block|}
DECL|method|closeConnection ()
name|void
name|closeConnection
parameter_list|()
block|{
if|if
condition|(
name|clientSocket
operator|!=
literal|null
operator|&&
operator|!
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring IOException encountered when closing client Socket"
argument_list|,
name|ioEx
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|clientSocket
operator|=
literal|null
expr_stmt|;
block|}
block|}
block|}
DECL|method|resetConnection ()
name|void
name|resetConnection
parameter_list|()
block|{
if|if
condition|(
name|clientSocket
operator|!=
literal|null
operator|&&
operator|!
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|setSoLinger
argument_list|(
literal|true
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SocketException
name|socketEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring SocketException encountered when setting SO_LINGER in preparation of resetting client Socket"
argument_list|,
name|socketEx
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring IOException encountered when resetting client Socket"
argument_list|,
name|ioEx
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|clientSocket
operator|=
literal|null
expr_stmt|;
block|}
block|}
block|}
comment|/**          * Read a MLLP-Framed message          *          * @param anInputStream source input stream          *          * @return the MLLP payload          *          * @throws IOException when the underlying Java Socket calls raise these exceptions          */
DECL|method|getMessage (InputStream anInputStream)
specifier|public
name|String
name|getMessage
parameter_list|(
name|InputStream
name|anInputStream
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
name|boolean
name|waitingForStartOfBlock
init|=
literal|true
decl_stmt|;
while|while
condition|(
name|waitingForStartOfBlock
condition|)
block|{
name|int
name|potentialStartCharacter
init|=
name|anInputStream
operator|.
name|read
argument_list|()
decl_stmt|;
switch|switch
condition|(
name|potentialStartCharacter
condition|)
block|{
case|case
name|MllpProtocolConstants
operator|.
name|END_OF_STREAM
case|:
return|return
literal|null
return|;
case|case
name|MllpProtocolConstants
operator|.
name|START_OF_BLOCK
case|:
name|waitingForStartOfBlock
operator|=
literal|false
expr_stmt|;
break|break;
default|default:
name|log
operator|.
name|warn
argument_list|(
literal|"START_OF_BLOCK character has not been received.  Out-of-band character received: {}"
argument_list|,
name|potentialStartCharacter
argument_list|)
expr_stmt|;
block|}
block|}
block|}
catch|catch
parameter_list|(
name|SocketException
name|socketEx
parameter_list|)
block|{
if|if
condition|(
name|clientSocket
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Client socket closed while waiting for START_OF_BLOCK"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|clientSocket
operator|.
name|isConnected
argument_list|()
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"SocketException encountered while waiting for START_OF_BLOCK"
argument_list|)
expr_stmt|;
name|resetConnection
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Unable to read from socket stream when expected START_OF_BLOCK - resetting connection "
argument_list|,
name|socketEx
argument_list|)
expr_stmt|;
name|resetConnection
argument_list|()
expr_stmt|;
block|}
block|}
return|return
literal|null
return|;
block|}
name|boolean
name|endOfMessage
init|=
literal|false
decl_stmt|;
name|StringBuilder
name|parsedMessage
init|=
operator|new
name|StringBuilder
argument_list|(
name|anInputStream
operator|.
name|available
argument_list|()
operator|+
literal|10
argument_list|)
decl_stmt|;
while|while
condition|(
operator|!
name|endOfMessage
condition|)
block|{
name|int
name|characterReceived
init|=
name|anInputStream
operator|.
name|read
argument_list|()
decl_stmt|;
switch|switch
condition|(
name|characterReceived
condition|)
block|{
case|case
name|MllpProtocolConstants
operator|.
name|START_OF_BLOCK
case|:
name|log
operator|.
name|error
argument_list|(
literal|"Received START_OF_BLOCK before END_OF_DATA.  Discarding data: {}"
argument_list|,
name|parsedMessage
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
case|case
name|MllpProtocolConstants
operator|.
name|END_OF_STREAM
case|:
name|log
operator|.
name|error
argument_list|(
literal|"Received END_OF_STREAM without END_OF_DATA.  Discarding data: {}"
argument_list|,
name|parsedMessage
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
case|case
name|MllpProtocolConstants
operator|.
name|END_OF_BLOCK
case|:
name|characterReceived
operator|=
name|anInputStream
operator|.
name|read
argument_list|()
expr_stmt|;
if|if
condition|(
name|characterReceived
operator|!=
name|MllpProtocolConstants
operator|.
name|END_OF_DATA
condition|)
block|{
name|log
operator|.
name|error
argument_list|(
literal|"Received {} when expecting END_OF_DATA after END_OF_BLOCK.  Discarding Hl7TestMessageGenerator: {}"
argument_list|,
name|characterReceived
argument_list|,
name|parsedMessage
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
name|endOfMessage
operator|=
literal|true
expr_stmt|;
break|break;
default|default:
name|parsedMessage
operator|.
name|append
argument_list|(
operator|(
name|char
operator|)
name|characterReceived
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|parsedMessage
operator|.
name|toString
argument_list|()
return|;
block|}
comment|/**          * Generates a HL7 Application Accept Acknowledgement          *          * @param hl7Message HL7 message that is being acknowledged          *          * @return a HL7 Application Accept Acknowlegdement          */
DECL|method|generateAcknowledgementMessage (String hl7Message)
specifier|private
name|String
name|generateAcknowledgementMessage
parameter_list|(
name|String
name|hl7Message
parameter_list|)
block|{
return|return
name|generateAcknowledgementMessage
argument_list|(
name|hl7Message
argument_list|,
literal|"AA"
argument_list|)
return|;
block|}
comment|/**          * Generates a HL7 Application Acknowledgement          *          * @param hl7Message          HL7 message that is being acknowledged          * @param acknowledgementCode AA, AE or AR          *          * @return a HL7 Application Acknowledgement          */
DECL|method|generateAcknowledgementMessage (String hl7Message, String acknowledgementCode)
specifier|private
name|String
name|generateAcknowledgementMessage
parameter_list|(
name|String
name|hl7Message
parameter_list|,
name|String
name|acknowledgementCode
parameter_list|)
block|{
return|return
name|generateAcknowledgement
argument_list|(
name|hl7Message
argument_list|,
name|acknowledgementCode
argument_list|)
return|;
block|}
DECL|method|uncheckedSleep (long milliseconds)
specifier|private
name|void
name|uncheckedSleep
parameter_list|(
name|long
name|milliseconds
parameter_list|)
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|milliseconds
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Sleep interrupted"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**          * Receives HL7 messages and replies with HL7 Acknowledgements.          *          * The exact behaviour of this method is very configurable, allowing simulation of varies error conditions.          */
annotation|@
name|Override
DECL|method|run ()
specifier|public
name|void
name|run
parameter_list|()
block|{
name|String
name|localAddress
init|=
name|clientSocket
operator|.
name|getLocalAddress
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|String
name|remoteAddress
init|=
name|clientSocket
operator|.
name|getRemoteSocketAddress
argument_list|()
operator|.
name|toString
argument_list|()
decl_stmt|;
name|log
operator|.
name|info
argument_list|(
literal|"Handling Connection: {} -> {}"
argument_list|,
name|localAddress
argument_list|,
name|remoteAddress
argument_list|)
expr_stmt|;
try|try
block|{
while|while
condition|(
operator|!
name|isInterrupted
argument_list|()
operator|&&
literal|null
operator|!=
name|clientSocket
operator|&&
name|clientSocket
operator|.
name|isConnected
argument_list|()
operator|&&
operator|!
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
name|InputStream
name|instream
decl_stmt|;
try|try
block|{
name|instream
operator|=
name|clientSocket
operator|.
name|getInputStream
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
if|if
condition|(
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
name|log
operator|.
name|debug
argument_list|(
literal|"Client socket was closed - ignoring exception"
argument_list|,
name|clientSocket
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"Unexpected IOException encounted getting input stream"
argument_list|,
name|ioEx
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|unexpectedEx
parameter_list|)
block|{
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
literal|"Unexpected exception encounted getting input stream"
argument_list|,
name|unexpectedEx
argument_list|)
throw|;
block|}
name|String
name|parsedHL7Message
decl_stmt|;
try|try
block|{
name|parsedHL7Message
operator|=
name|getMessage
argument_list|(
name|instream
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|SocketTimeoutException
name|timeoutEx
parameter_list|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Waiting for message from client"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
literal|null
operator|!=
name|parsedHL7Message
operator|&&
name|parsedHL7Message
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
operator|++
name|messageCounter
expr_stmt|;
if|if
condition|(
name|closeSocketBeforeAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Closing socket before sending acknowledgement"
argument_list|)
expr_stmt|;
name|clientSocket
operator|.
name|shutdownInput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|shutdownOutput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|resetSocketBeforeAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Resetting socket before sending acknowledgement"
argument_list|)
expr_stmt|;
try|try
block|{
name|clientSocket
operator|.
name|setSoLinger
argument_list|(
literal|true
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioEx
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring IOException encountered setting SO_LINGER when prepareing to reset socket"
argument_list|,
name|ioEx
argument_list|)
expr_stmt|;
block|}
name|clientSocket
operator|.
name|shutdownInput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|shutdownOutput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
break|break;
block|}
name|String
name|acknowledgmentMessage
decl_stmt|;
if|if
condition|(
name|acknowledgementString
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|sendApplicationErrorAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
operator|||
name|sendApplicationErrorAcknowledgement
argument_list|(
name|parsedHL7Message
argument_list|)
condition|)
block|{
name|acknowledgmentMessage
operator|=
name|generateAcknowledgementMessage
argument_list|(
name|parsedHL7Message
argument_list|,
literal|"AE"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sendApplicationRejectAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
operator|||
name|sendApplicationRejectAcknowledgement
argument_list|(
name|parsedHL7Message
argument_list|)
condition|)
block|{
name|acknowledgmentMessage
operator|=
name|generateAcknowledgementMessage
argument_list|(
name|parsedHL7Message
argument_list|,
literal|"AR"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|acknowledgmentMessage
operator|=
name|generateAcknowledgementMessage
argument_list|(
name|parsedHL7Message
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|acknowledgmentMessage
operator|=
name|acknowledgementString
expr_stmt|;
block|}
name|BufferedOutputStream
name|outstream
init|=
operator|new
name|BufferedOutputStream
argument_list|(
name|clientSocket
operator|.
name|getOutputStream
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|sendOutOfBandData
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|byte
index|[]
name|outOfBandDataBytes
init|=
literal|"Out Of Band Hl7TestMessageGenerator"
operator|.
name|getBytes
argument_list|()
decl_stmt|;
name|outstream
operator|.
name|write
argument_list|(
name|outOfBandDataBytes
argument_list|,
literal|0
argument_list|,
name|outOfBandDataBytes
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|excludeStartOfBlock
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"NOT sending START_OF_BLOCK"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outstream
operator|.
name|write
argument_list|(
name|MllpProtocolConstants
operator|.
name|START_OF_BLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|delayBeforeStartOfBlock
operator|>
literal|0
condition|)
block|{
name|uncheckedSleep
argument_list|(
name|delayBeforeStartOfBlock
argument_list|)
expr_stmt|;
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|excludeAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"NOT sending Acknowledgement body"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|delayBeforeAcknowledgement
operator|>
literal|0
condition|)
block|{
name|uncheckedSleep
argument_list|(
name|delayBeforeAcknowledgement
argument_list|)
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Buffering Acknowledgement\n\t{}"
argument_list|,
name|acknowledgmentMessage
operator|.
name|replace
argument_list|(
literal|'\r'
argument_list|,
literal|'\n'
argument_list|)
argument_list|)
expr_stmt|;
name|byte
index|[]
name|ackBytes
init|=
name|acknowledgmentMessage
operator|.
name|getBytes
argument_list|()
decl_stmt|;
if|if
condition|(
name|delayDuringAcknowledgement
operator|>
literal|0
condition|)
block|{
name|int
name|firstHalf
init|=
name|ackBytes
operator|.
name|length
operator|/
literal|2
decl_stmt|;
name|outstream
operator|.
name|write
argument_list|(
name|ackBytes
argument_list|,
literal|0
argument_list|,
name|firstHalf
argument_list|)
expr_stmt|;
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
name|uncheckedSleep
argument_list|(
name|delayDuringAcknowledgement
argument_list|)
expr_stmt|;
name|outstream
operator|.
name|write
argument_list|(
name|ackBytes
argument_list|,
name|firstHalf
argument_list|,
name|ackBytes
operator|.
name|length
operator|-
name|firstHalf
argument_list|)
expr_stmt|;
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outstream
operator|.
name|write
argument_list|(
name|ackBytes
argument_list|,
literal|0
argument_list|,
name|ackBytes
operator|.
name|length
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|delayAfterAcknowledgement
operator|>
literal|0
condition|)
block|{
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
name|uncheckedSleep
argument_list|(
name|delayAfterAcknowledgement
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|excludeEndOfBlock
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"NOT sending END_OF_BLOCK"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outstream
operator|.
name|write
argument_list|(
name|MllpProtocolConstants
operator|.
name|END_OF_BLOCK
argument_list|)
expr_stmt|;
if|if
condition|(
name|delayAfterEndOfBlock
operator|>
literal|0
condition|)
block|{
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
name|uncheckedSleep
argument_list|(
name|delayAfterEndOfBlock
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|excludeEndOfData
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"NOT sending END_OF_DATA"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outstream
operator|.
name|write
argument_list|(
name|MllpProtocolConstants
operator|.
name|END_OF_DATA
argument_list|)
expr_stmt|;
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Writing Acknowledgement\n\t{}"
argument_list|,
name|acknowledgmentMessage
operator|.
name|replace
argument_list|(
literal|'\r'
argument_list|,
literal|'\n'
argument_list|)
argument_list|)
expr_stmt|;
name|uncheckedFlush
argument_list|(
name|outstream
argument_list|)
expr_stmt|;
if|if
condition|(
name|closeSocketAfterAcknowledgement
argument_list|(
name|messageCounter
argument_list|)
condition|)
block|{
name|log
operator|.
name|info
argument_list|(
literal|"Closing Client"
argument_list|)
expr_stmt|;
name|clientSocket
operator|.
name|shutdownInput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|shutdownOutput
argument_list|()
expr_stmt|;
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|String
name|errorMessage
init|=
literal|"Error while reading and writing from clientSocket"
decl_stmt|;
name|log
operator|.
name|error
argument_list|(
name|errorMessage
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
name|errorMessage
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|clientSocket
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|String
name|errorMessage
init|=
literal|"Error while attempting to close to client Socket"
decl_stmt|;
name|log
operator|.
name|error
argument_list|(
name|errorMessage
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|MllpJUnitResourceException
argument_list|(
name|errorMessage
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
block|}
name|log
operator|.
name|debug
argument_list|(
literal|"Client Connection Finished: {} -> {}"
argument_list|,
name|localAddress
argument_list|,
name|remoteAddress
argument_list|)
expr_stmt|;
block|}
DECL|method|uncheckedFlush (OutputStream outputStream)
specifier|private
name|void
name|uncheckedFlush
parameter_list|(
name|OutputStream
name|outputStream
parameter_list|)
block|{
try|try
block|{
name|outputStream
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Ignoring exception caught while flushing output stream"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
DECL|method|interrupt ()
specifier|public
name|void
name|interrupt
parameter_list|()
block|{
if|if
condition|(
name|clientSocket
operator|!=
literal|null
operator|&&
name|clientSocket
operator|.
name|isConnected
argument_list|()
operator|&&
operator|!
name|clientSocket
operator|.
name|isClosed
argument_list|()
condition|)
block|{
try|try
block|{
name|clientSocket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|ex
parameter_list|)
block|{
name|log
operator|.
name|warn
argument_list|(
literal|"Exception encountered closing client socket on interrput"
argument_list|,
name|ex
argument_list|)
expr_stmt|;
block|}
block|}
name|super
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_class

end_unit

